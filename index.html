<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ff4da6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>ブーハー ABC スターター</title>

  <script>
    /* Minimal early fallback for no-JS browsers */
    function startApp(){
      const hello = document.getElementById('hello');
      if (hello) hello.style.display = 'none';
      const img = document.getElementById('letterImg');
      if (img) { img.src = './1.jpg'; img.alt = 'レター画像'; }
    }
    window.startApp = startApp;
  </script>

  <style>
    :root { --vh: 100vh; } /* will be corrected by JS on mobile */

    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{ -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/cover no-repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.22);z-index:-1}

    #go:target ~ #hello{display:none} /* CSS-only fallback */

    /* Hello */
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.78);z-index:10}
    .hello-card{position:relative;z-index:11;background:#fff;border-radius:20px;padding:24px;max-width:480px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:140px;height:auto;margin:0 auto;display:block}
    .hello-card h1{margin:12px 0 6px;font-size:24px;line-height:1.2}
    .hello-card p{margin:8px 0;font-size:14px;color:#444}
    .start-link{
      display:inline-block;margin-top:16px;padding:12px 20px;font-size:18px;font-weight:900;text-decoration:none;
      background:#ff4da6;color:#fff;border-radius:14px;box-shadow:0 10px 18px rgba(255,77,166,.28);cursor:pointer
    }
    .start-link:active{transform:scale(.98)}

    /* Top bar */
    .topbar{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px;
      padding:10px 16px; padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
    }
    .chip{
      background:#ffffffcc; backdrop-filter:saturate(1.2) blur(2px);
      border:1px solid rgba(0,0,0,.06); border-radius:999px;
      padding:8px 12px; display:flex; align-items:center; gap:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .lab{font-weight:900}
    .rail{position:relative; width:200px; height:10px; background:#ffe0ef; border-radius:999px; overflow:hidden}
    .fill{position:absolute; inset:0 auto 0 0; width:0; height:100%; background:#ff4da6}

    .rail.clock{background:#e8e3ff}
    .fill.clock{background:#7c5cff}
    .count{font-weight:900; font-variant-numeric: tabular-nums}

    /* Letter screen: use --vh to avoid mobile 100vh bugs */
    .letter-screen{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      height:calc(var(--vh) - 96px); /* was calc(100vh - 96px) */
      padding:16px;gap:16px;text-align:center
    }
    .card-wrap{display:grid;place-items:center;width:min(900px,96vw);min-height:40vh}
    .card-wrap img{max-width:100%;max-height:70vh;object-fit:contain;border-radius:12px;box-shadow:none}

    /* Practice nav (appears from B) */
    .nav{
      display:flex; gap:8px; margin-top:6px; visibility:hidden;
    }
    .nav button{
      padding:12px 16px; border-radius:12px; border:1px solid rgba(0,0,0,.08); background:#fff; cursor:pointer; font-weight:800;
    }
    .nav button[disabled]{opacity:.45; cursor:not-allowed}

    .buttons{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:12px;width:min(680px,92vw)}
    .btn-audio{display:flex;flex-direction:column;align-items:center;gap:6px;border:0;border-radius:18px;padding:16px 18px;font-size:18px;font-weight:900;color:#fff;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.20);transition:transform .12s, background .12s, opacity .12s}
    .btn-audio .num{font-size:26px}
    .btn1{background:#ff5959}.btn2{background:#06b6d4}.btn3{background:#ffd166;color:#111}.btn4{background:#7c5cff}
    .btn-audio:active{transform:scale(.94)}
    .btn1.done{background:#ff7a7a}
    .btn2.done{background:#16c1de}
    .btn3.done{background:#ffe08c;color:#111}
    .btn4.done{background:#9a86ff}
    .btn-audio.done::after{content:" ✓";font-weight:900;font-size:14px;margin-left:4px}
    .btn-audio.locked{opacity:.45;pointer-events:none}

    .btn-finish{margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;box-shadow:0 10px 18px rgba(0,0,0,.18)}
    .btn-finish:active{transform:scale(.96)}

    canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:50}

    /* QUIZ (internal) */
    #quiz{position:fixed;inset:0;z-index:80;display:none}
    #quiz.active{display:block}
    .q-back{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .q-card{position:relative;z-index:81;background:#fff;border-radius:20px;max-width:900px;margin:6vh auto;padding:16px 16px 18px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
    .q-title{margin:6px 0 2px;font-size:24px}
    .q-prompt{margin:4px 0 12px;color:#444}
    .q-ctrl{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .q-grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .q-item{background:#f7f7fb;border:2px solid transparent;border-radius:14px;padding:8px;display:grid;place-items:center;cursor:pointer;transition:transform .1s, border-color .12s}
    .q-item img{width:100%;height:170px;object-fit:contain}
    .q-item:active{transform:scale(.98)}
    .q-item.correct{border-color:#22c55e}
    .q-item.wrong{border-color:#ef4444}
    .q-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .q-btn{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer}
    .q-ok{background:#28a745}
    .q-progress{font-weight:800}
    .q-hint{color:#555;font-size:14px}
    @media (max-width:820px){.q-grid{grid-template-columns:repeat(2,1fr)}.q-item img{height:140px}}
  </style>
</head>
<body>
  <div id="go"></div>

  <div class="bg"></div>
  <div class="overlay"></div>

  <!-- Top bar -->
  <div class="topbar">
    <!-- Left: PROGRESS A→Z METER with labels -->
    <div class="chip">
      <span class="lab">A</span>
      <div class="rail" aria-label="A→Z 進捗">
        <div id="azFill" class="fill"></div>
      </div>
      <span class="lab">Z</span>
    </div>

    <!-- Center: Booha -->
    <img src="./playful-pink-booha.png" alt="Booha" style="width:60px;height:60px;object-fit:contain" />

    <!-- Right: purple live countdown -->
    <div class="chip">
      <span class="lab">次のアンロック</span>
      <div class="rail clock" aria-label="24h カウントダウン">
        <div id="cdFill" class="fill clock"></div>
      </div>
      <span id="cdText" class="count">00:00:00</span>
    </div>
  </div>

  <!-- Hello / Start -->
  <div id="hello" class="hello" aria-live="polite">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>スターターアプリへようこそ！</h1>
      <p>このアプリをホーム画面に追加してください。</p>
      <p>次の文字は <strong>24時間後</strong> にアンロックされます！</p>
      <a class="start-link" href="#go" id="startLink">スタート</a>
    </div>
  </div>

  <!-- Letter screen -->
  <div class="letter-screen">
    <!-- Practice arrows (from B; finished letters only; never past lock) -->
    <div class="nav" id="nav">
      <button id="prev" type="button">← もどる</button>
      <button id="next" type="button">すすむ →</button>
    </div>

    <div class="card-wrap">
      <img id="letterImg" src="./1.jpg" alt="レター画像" loading="eager" decoding="async" />
    </div>

    <div id="btnRow" class="buttons">
      <button id="btn1" type="button" class="btn-audio btn1"><span class="num">①</span><small>リピート</small></button>
      <button id="btn2" type="button" class="btn-audio btn2"><span class="num">②</span><small>いっしょに読む</small></button>
      <button id="btn3" type="button" class="btn-audio btn3"><span class="num">③</span><small>リピート</small></button>
      <button id="btn4" type="button" class="btn-audio btn4"><span class="num">④</span><small>スペシャル！</small></button>
    </div>

    <button id="finishBtn" type="button" class="btn-finish">できた！</button>
  </div>

  <canvas id="confetti"></canvas>

  <!-- SFX -->
  <audio id="clickAudio" src="assets/sfx/click.mp3" preload="auto"></audio>
  <audio id="magicAudio" src="assets/sfx/magic.mp3" preload="auto"></audio>

  <!-- QUIZ (internal) -->
  <div id="quiz" aria-hidden="true">
    <div class="q-back"></div>
    <div class="q-card" role="dialog" aria-modal="true" aria-labelledby="quizTitle">
      <h2 id="quizTitle" class="q-title">クイズ</h2>
      <p class="q-prompt">音声を聞いて、正しい<strong>文字</strong>をえらぼう！</p>
      <div class="q-ctrl">
        <button id="qPlay" type="button" class="q-btn">▶︎ 再生</button>
        <span id="qHint" class="q-hint"></span>
      </div>
      <div id="qGrid" class="q-grid"></div>
      <div class="q-bottom">
        <div id="qProgress" class="q-progress">1 / 1</div>
        <button id="qClose" type="button" class="q-btn q-ok" style="display:none">OK</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Viewport fix for mobile 100vh ---------- */
    function setVH(){ document.documentElement.style.setProperty('--vh', window.innerHeight + 'px'); }
    setVH(); window.addEventListener('resize', setVH); window.addEventListener('orientationchange', setVH);

    /* ---------- Versioned reset (bump to clear stale cache on mobile) ---------- */
    const APP_VERSION = "abc-2025-10-07AZ-progress-nav-v3";
    const LS_KEY_APP_VERSION = "abc_app_version";
    (function versionReset(){
      try{
        const v = localStorage.getItem(LS_KEY_APP_VERSION);
        if(v !== APP_VERSION){
          localStorage.removeItem("abc_done_letters");
          localStorage.removeItem("abc_last_test_m");
          localStorage.removeItem("abc_unlock_idx");
          localStorage.removeItem("abc_next_unlock_ms");
          localStorage.setItem(LS_KEY_APP_VERSION, APP_VERSION);
        }
      }catch{}
    })();

    /* ---------- Start link: make sure tap always triggers init ---------- */
    const startLink = document.getElementById('startLink');
    startLink.addEventListener('click', (e)=>{ startAppFull(); });
    startLink.addEventListener('touchstart', ()=>{ startAppFull(); }, {passive:true});

    /* ---------- Audio (no overlap) ---------- */
    let activeAudio = null;
    function stopActive(){ try{ if(activeAudio){ activeAudio.pause(); activeAudio.currentTime = 0; } }catch(e){} activeAudio=null; }
    function playSound(src){ stopActive(); try{ activeAudio = new Audio(src); activeAudio.play().catch(()=>{});}catch(e){} }
    window.addEventListener('pagehide', stopActive);
    window.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopActive(); });

    /* ---------- Constants & DOM ---------- */
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""); // 26
    const MAX_IDX = 25; const TOTAL_LETTERS = 26; const H24 = 24*60*60*1000;

    const LS_KEY_DONE = "abc_done_letters";
    const LS_KEY_LAST_TEST = "abc_last_test_m";
    const LS_KEY_UNLOCK_IDX = "abc_unlock_idx";
    const LS_KEY_NEXT_UNLOCK = "abc_next_unlock_ms";

    const azFill = document.getElementById("azFill");
    const cdFill = document.getElementById("cdFill");
    const cdText = document.getElementById("cdText");

    const nav = document.getElementById("nav");
    const prev = document.getElementById("prev");
    const next = document.getElementById("next");

    const letterImg = document.getElementById("letterImg");
    const btnRow = document.getElementById("btnRow");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const btns = [btn1,btn2,btn3,btn4];
    const finishBtn = document.getElementById("finishBtn");
    const clickAudio = document.getElementById("clickAudio");
    const magicAudio = document.getElementById("magicAudio");

    const quiz = document.getElementById("quiz");
    const qGrid = document.getElementById("qGrid");
    const qPlay = document.getElementById("qPlay");
    const qHint = document.getElementById("qHint");
    const qClose = document.getElementById("qClose");
    const qProgress = document.getElementById("qProgress");

    /* ---------- State ---------- */
    let letterIdx = 0;
    let doneList = loadDoneList();
    let doneSet = new Set(doneList);
    let lastMilestoneDone = loadNumber(LS_KEY_LAST_TEST, 0);
    let unlockIdx = loadNumber(LS_KEY_UNLOCK_IDX, 0);
    let nextUnlockMs = loadNumber(LS_KEY_NEXT_UNLOCK, 0);
    let currentStep = 1;

    /* ---------- Helpers ---------- */
    function loadDoneList(){ try{ const raw = JSON.parse(localStorage.getItem(LS_KEY_DONE) || "[]"); return Array.isArray(raw)?raw:[]; }catch{ return []; } }
    function saveDone(){ try{ localStorage.setItem(LS_KEY_DONE, JSON.stringify(doneList)); }catch{} }
    function loadNumber(k, d){ const n=Number(localStorage.getItem(k) ?? d); return Number.isFinite(n)?n:d; }
    function saveNumber(k, v){ try{ localStorage.setItem(k, String(v)); }catch{} }

    function getCardBase(i){ return i*4; }
    function firstCardSrc(idx){ return `./${getCardBase(idx)+1}.jpg`; }

    function showCard(n){
      const base = getCardBase(Math.min(letterIdx, MAX_IDX));
      const num = base + n;
      letterImg.src = `./${num}.jpg`;
      letterImg.alt = `レター画像`;
    }

    function showFinal(){
      letterImg.src = './finished.jpg';
      letterImg.alt = 'FINISHED';
      btnRow.style.display = 'none';
      finishBtn.style.display = 'none';
      nav.style.visibility = 'visible';
      prev.disabled = getPrevFinished(letterIdx) === null;
      next.disabled = true;
    }

    function updateProgressMeter(){
      const pct = (doneSet.size / TOTAL_LETTERS) * 100;
      azFill.style.width = pct + "%";
    }

    function now(){ return Date.now(); }
    function msToHMS(ms){
      if (ms <= 0) return "00:00:00";
      const s = Math.floor(ms/1000);
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }
    function updateCountdown(){
      if (nextUnlockMs > 0 && now() < nextUnlockMs){
        const remain = nextUnlockMs - now();
        const pct = Math.max(0, Math.min(100, (1 - (remain / H24)) * 100));
        cdFill.style.width = pct + "%";
        cdText.textContent = msToHMS(remain);
      }else if (nextUnlockMs > 0 && now() >= nextUnlockMs){
        cdFill.style.width = "100%";
        cdText.textContent = "00:00:00";
      }else{
        cdFill.style.width = "0%";
        cdText.textContent = "00:00:00";
      }
    }

    function refreshUnlocks(){
      if (nextUnlockMs > 0 && now() >= nextUnlockMs && unlockIdx < MAX_IDX){
        unlockIdx = Math.min(unlockIdx + 1, MAX_IDX);
        nextUnlockMs = 0;
        saveNumber(LS_KEY_UNLOCK_IDX, unlockIdx);
        saveNumber(LS_KEY_NEXT_UNLOCK, nextUnlockMs);
      }
      updateCountdown();
      updateProgressMeter();
      updateNavVisibility();
    }
    setInterval(refreshUnlocks, 1000);
    window.addEventListener('focus', refreshUnlocks);

    function clampToUnlocked(i){ return Math.max(0, Math.min(i, unlockIdx)); }

    function resetButtons(){ btns.forEach(b=> b.classList.remove('done','locked')); }
    function lockButtonsByStep(){
      btns.forEach((b,idx)=>{
        const step = idx+1;
        b.classList.toggle('locked', step>currentStep);
        b.classList.toggle('done', step<currentStep);
      });
      const show = (currentStep>4) && !doneSet.has(letters[letterIdx]);
      finishBtn.style.display = show ? 'inline-block' : 'none';
    }

    /* ---------- Practice Nav (finished letters only) ---------- */
    function getFinishedIndicesSorted(){
      return doneList.map(L=>letters.indexOf(L)).filter(i=>i>=0).sort((a,b)=>a-b);
    }
    function getPrevFinished(fromIdx){
      const arr = getFinishedIndicesSorted().filter(i=>i<=unlockIdx);
      let prev = null;
      for(const i of arr){ if(i < fromIdx) prev = i; else break; }
      return prev;
    }
    function getNextFinished(fromIdx){
      const arr = getFinishedIndicesSorted().filter(i=>i<=unlockIdx);
      for(const i of arr){ if(i > fromIdx) return i; }
      return null;
    }
    function updateNavVisibility(){
      nav.style.visibility = (unlockIdx >= 1) ? 'visible' : 'hidden';
      prev.disabled = (getPrevFinished(letterIdx) === null);
      next.disabled = (getNextFinished(letterIdx) === null);
    }

    prev.onclick = ()=>{
      const p = getPrevFinished(letterIdx);
      if(p === null) return;
      letterIdx = p;
      currentStep = 5;
      stopActive(); resetButtons(); lockButtonsByStep();
      showCard(1);
      updateNavVisibility();
    };
    next.onclick = ()=>{
      const n = getNextFinished(letterIdx);
      if(n === null) return;
      letterIdx = n;
      currentStep = 5;
      stopActive(); resetButtons(); lockButtonsByStep();
      showCard(1);
      updateNavVisibility();
    };

    /* ---------- Letter audio ---------- */
    function playLetterTimes(times){
      const L = letters[letterIdx];
      const name = L.repeat(times); // A, AA, AAA, AAAA
      const src = `assets/audio/${name}.m4a`;
      playSound(src);
    }

    /* ---------- Start ---------- */
    function firstUnfinishedUnlocked(){
      for (let i=0;i<=unlockIdx;i++){
        if (!doneSet.has(letters[i])) return i;
      }
      return unlockIdx;
    }
    function startAppFull(){
      startApp();
      refreshUnlocks();
      letterIdx = clampToUnlocked(firstUnfinishedUnlocked());
      currentStep = doneSet.has(letters[letterIdx]) ? 5 : 1;
      btnRow.style.display = '';
      resetButtons(); lockButtonsByStep();
      if(doneSet.size === TOTAL_LETTERS){ showFinal(); } else { showCard(1); }
      updateProgressMeter();
      updateNavVisibility();
    }
    window.startAppFull = startAppFull;
    if(location.hash === '#go'){ startAppFull(); }

    /* ---------- Step handlers (order enforced) ---------- */
    btn1.onclick = ()=> handleStep(1);
    btn2.onclick = ()=> handleStep(2);
    btn3.onclick = ()=> handleStep(3);
    btn4.onclick = ()=> handleStep(4);

    function handleStep(step){
      if(doneSet.size === TOTAL_LETTERS) return;
      if(step !== currentStep) return;
      showCard(step);
      playLetterTimes(step);
      currentStep++;
      lockButtonsByStep();
    }

    /* ---------- Finish current letter (single-use per set) ---------- */
    function maybeOpenQuizAfterFinish(){
      const groupsDone = Math.floor(doneSet.size / 5); // 5,10,15,20,25
      const lastStored = loadNumber(LS_KEY_LAST_TEST, 0);
      if (doneSet.size > 0 && doneSet.size % 5 === 0 && groupsDone > lastStored){
        localStorage.setItem(LS_KEY_LAST_TEST, String(groupsDone));
        openQuiz();
      }
    }

    finishBtn.onclick = ()=>{
      const L = letters[letterIdx];
      if(doneSet.has(L)) return;

      try{ clickAudio.currentTime=0; clickAudio.play().catch(()=>{});}catch{}
      doneSet.add(L); doneList.push(L); saveDone();

      try{ magicAudio.currentTime=0; magicAudio.play().catch(()=>{});}catch{}
      startFireworks(4000); /* longer confetti on finish */
      finishBtn.style.display = 'none';

      if (letterIdx === unlockIdx && unlockIdx < MAX_IDX){
        nextUnlockMs = Date.now() + H24;
        saveNumber(LS_KEY_NEXT_UNLOCK, nextUnlockMs);
      }

      updateProgressMeter(); updateNavVisibility();

      if(doneSet.size === TOTAL_LETTERS){
        showFinal();
      }else{
        maybeOpenQuizAfterFinish();
        currentStep = 1;
        resetButtons(); lockButtonsByStep();
        showCard(1);
      }
    };

    /* ---------- Confetti (longer) ---------- */
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext("2d");
    function startFireworks(duration){
      let confettiRunning=true; resize();
      const pieces = Array.from({length:320}).map(()=>({
        x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height,
        r: Math.random()*8+3, d: Math.random()*1+0.5, c: `hsl(${Math.random()*360},100%,50%)`
      }));
      const end = Date.now() + duration;
      (function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const p of pieces){
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,2*Math.PI); ctx.fillStyle=p.c; ctx.fill();
          p.y+=p.d*4; if(p.y>canvas.height){ p.y=-10; p.x=Math.random()*canvas.width; }
        }
        if(Date.now()<end && confettiRunning) requestAnimationFrame(draw);
        else { ctx.clearRect(0,0,canvas.width,canvas.height); confettiRunning=false; }
      })();
    }
    window.onresize = resize; function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; } resize();

    /* ---------- QUIZ (confetti longer too) ---------- */
    function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
    function playLetterCueByIndex(idx){
      const L = letters[idx];
      qHint.textContent = `（${L} の音）`;
      playSound(`assets/audio/${L}.m4a`);
    }
    function openQuiz(){
      qGrid.innerHTML = '';
      const finishedIdx = doneList.map(L=>letters.indexOf(L));
      const recent = finishedIdx.slice(-5).filter(i=>i>=0 && i<=unlockIdx);
      let pool = recent.length>=4 ? recent : Array.from({length:unlockIdx+1}, (_,i)=>i);
      pool = shuffle(pool).slice(0,4);
      const correctIdx = pool[Math.floor(Math.random()*pool.length)];

      for(const idx of pool){
        const btn = document.createElement('button');
        btn.type='button'; btn.className='q-item';
        const img = document.createElement('img');
        img.src = firstCardSrc(idx);
        img.alt = 'えらぶレター';
        btn.appendChild(img);
        btn.onclick = ()=>{
          const ok = idx === correctIdx;
          btn.classList.add(ok?'correct':'wrong');
          if(ok){
            try{ magicAudio.currentTime=0; magicAudio.play().catch(()=>{});}catch{}
            [...qGrid.querySelectorAll('.q-item')].forEach(b=>b.disabled=true);
            startFireworks(4000);
            qClose.style.display = 'inline-block';
          }else{
            setTimeout(()=> btn.classList.remove('wrong'), 380);
          }
        };
        qGrid.appendChild(btn);
      }

      qPlay.onclick = ()=> playLetterCueByIndex(correctIdx);
      qHint.textContent = ''; qClose.style.display = 'none'; qProgress.textContent = '1 / 1';
      quiz.classList.add('active');

      playLetterCueByIndex(correctIdx);

      const backdropClose = (e)=>{ if(e.target.classList.contains('q-back')) closeQuiz(); };
      quiz.addEventListener('click', backdropClose, {once:true});
      qClose.onclick = closeQuiz;
    }
    function closeQuiz(){ quiz.classList.remove('active'); stopActive(); }
  </script>
</body>
</html>
