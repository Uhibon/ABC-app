<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABC アプリ – A/D 版</title>
  <link rel="icon" href="booha-ghost.png">
  <style>
    :root{ --ink:#222; --muted:#555; --bg:#f7f7fb; --card:#fff; --accent:#7c3aed; --ok:#22c55e; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif;background:var(--bg);color:var(--ink);}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .app{width:min(960px,100%);background:var(--card);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid #eee;background:#fafafa}
    header h1{font-size:18px;margin:0;letter-spacing:.03em}
    header .spacer{flex:1}
    header .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#eee}

    .screen{display:none;padding:24px;background:#fff}
    .screen.active{display:block}

    .hero{display:grid;gap:16px;text-align:center}
    .hero h2{font-size:28px;margin:0}
    .hero p{margin:0;color:var(--muted)}
    .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(124,58,237,.25);}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .ghost{width:72px;height:72px}

    .stage{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media (max-width:860px){.stage{grid-template-columns:1fr}}

    .cardArea{position:relative;min-height:360px;background:#f3f4f6;border:2px dashed #e5e7eb;border-radius:16px;display:grid;place-items:center;overflow:hidden}
    .cardArea img{width:100%;height:100%;object-fit:contain;}
    .cardMeta{position:absolute;inset:auto 12px 12px auto;background:#0009;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px}

    .controls{display:grid;gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .ctl{flex:1;min-width:110px}

    .numBtn{flex:1;min-width:60px;appearance:none;border:2px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px 10px;font-size:18px;font-weight:800;cursor:pointer;transition:transform .05s ease, box-shadow .15s ease, background .2s}
    .numBtn .jp{display:block;font-size:12px;color:var(--muted);font-weight:600}
    .numBtn:active{transform:translateY(1px)}
    .numBtn.active{outline:0;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.2);background:#f5f3ff}

    .sys{display:flex;gap:10px}
    .sys .btn{background:#111}
    .sys .ghostBtn{background:#10b981}
    .sys .reset{background:#ef4444}

    .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:var(--ok);transition:width .3s}

    .badge{font-size:12px;color:var(--muted)}

    .toast{position:fixed;inset:auto 16px 16px 16px;display:none}
    .toast.show{display:block}
    .toast .bubble{background:#111;color:#fff;padding:12px 14px;border-radius:12px;display:inline-block}

    .confetti{position:absolute;inset:0;pointer-events:none}
    .dot{position:absolute;width:10px;height:10px;border-radius:50%;animation:pop 800ms ease-out forwards}
    @keyframes pop{0%{transform:translate(var(--x,0),var(--y,0)) scale(.6);opacity:1}100%{transform:translate(calc(var(--x,0)*8),calc(var(--y,0)*8)) scale(1.2);opacity:0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <header>
        <img class="ghost" src="booha-ghost.png" alt="booha" onerror="this.style.display='none'"/>
        <h1>ABC アプリ <span class="badge">A / D 版</span></h1>
        <div class="spacer"></div>
        <div class="pill" id="statusPill">未開始</div>
      </header>

      <!-- START -->
      <section id="start" class="screen active">
        <div class="hero">
          <h2>スタートしよう！</h2>
          <p>きょうは <strong>A</strong> から。1にち1もじ、ゲームみたいにたのしくおぼえよう！</p>
          <button class="btn" id="startBtn">スタート</button>
          <p class="badge">※ いまは A〜D があそべるよ（テストよう）</p>
        </div>
      </section>

      <!-- MAIN -->
      <section id="main" class="screen">
        <div class="stage">
          <div class="cardArea" id="cardArea">
            <img id="cardImg" alt="カード"/>
            <div class="cardMeta" id="cardMeta">A - 1 / 4</div>
            <div class="confetti" id="confetti"></div>
          </div>

          <div class="controls">
            <div class="row">
              <button class="numBtn" data-idx="0"><span>1</span><span class="jp">カード1</span></button>
              <button class="numBtn" data-idx="1"><span>2</span><span class="jp">カード2</span></button>
              <button class="numBtn" data-idx="2"><span>3</span><span class="jp">カード3</span></button>
              <button class="numBtn" data-idx="3"><span>4</span><span class="jp">カード4</span></button>
            </div>
            <div class="row sys">
              <button class="btn ctl" id="prevBtn">← まえ</button>
              <button class="btn ctl" id="nextBtn">つぎ →</button>
            </div>
            <div class="row sys">
              <button class="btn ctl ghostBtn" id="finishBtn">おわった！（ごうかく）</button>
              <button class="btn ctl reset" id="resetBtn">リセット（テスト用）</button>
            </div>
            <div>
              <div class="badge" id="letterBadge">現在：A（ロック解除）｜次：B（ロック中）</div>
              <div class="progress" aria-label="progress">
                <div class="bar" id="bar"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="toast" id="toast"><div class="bubble" id="toastMsg"></div></div>
    </div>
  </div>

  <audio id="sfxClick" preload="auto" src="assets/sfx/click.mp3"></audio>
  <audio id="sfxMagic" preload="auto" src="assets/sfx/magic.mp3"></audio>
  <!-- レター音声: A..AAAAA, B..BBBBB, C..CCCCC, D..DDDDD を assets/audio/ に配置 -->

  <script>
  const cfg = {
    delayMs: 300, // いまは未使用（将来の調整用）
    letters: [
      {
        key:'A', unlocked:true,
        // 画像は 1-4.jpg / 文字ごとに4枚割当。A:1-4, B:5-8, C:9-12, D:13-16
        imgIdx:[1,2,3,4],
        audio:['A.m4a','AA.m4a','AAA.m4a','AAAA.m4a','AAAAA.m4a']
      },
      {
        key:'B', unlocked:false,
        imgIdx:[5,6,7,8],
        audio:['B.m4a','BB.m4a','BBB.m4a','BBBB.m4a','BBBBB.m4a']
      },
      {
        key:'C', unlocked:false,
        imgIdx:[9,10,11,12],
        audio:['C.m4a','CC.m4a','CCC.m4a','CCCC.m4a','CCCCC.m4a']
      },
      {
        key:'D', unlocked:false,
        imgIdx:[13,14,15,16],
        audio:['D.m4a','DD.m4a','DDD.m4a','DDDD.m4a','DDDDD.m4a']
      }
      // ここに E〜Z を追加予定
    ]
  };

  const els = {
    screens:{start:$('#start'), main:$('#main')},
    startBtn:$('#startBtn'), statusPill:$('#statusPill'),
    cardArea:$('#cardArea'), cardImg:$('#cardImg'), cardMeta:$('#cardMeta'),
    numBtns:$$('.numBtn'), prevBtn:$('#prevBtn'), nextBtn:$('#nextBtn'),
    finishBtn:$('#finishBtn'), resetBtn:$('#resetBtn'),
    letterBadge:$('#letterBadge'), bar:$('#bar'),
    toast:$('#toast'), toastMsg:$('#toastMsg'), confetti:$('#confetti'),
    sfx:$('#sfxClick')
  };

  const state = { li:0, ci:0, doneThisLetter:false };

  // ---- Utils ----
  function $(q){return document.querySelector(q)}
  function $$(q){return Array.from(document.querySelectorAll(q))}
  function show(id){ Object.values(els.screens).forEach(s=>s.classList.remove('active')); id.classList.add('active'); }
  function toast(msg){ els.toastMsg.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'), 1800); }
  function save(){ localStorage.setItem('abc_state', JSON.stringify({li:state.li, unlocked:cfg.letters.map(l=>l.unlocked)})) }
  function load(){ try{ const d=JSON.parse(localStorage.getItem('abc_state')); if(!d) return; state.li=d.li??0; d.unlocked?.forEach((v,i)=>cfg.letters[i]&&(cfg.letters[i].unlocked=v)); }catch(e){} }

  // Preload images & audio
  function preload(){
    const imgs = cfg.letters.flatMap(l=>l.imgIdx.map(n=>`assets/cards/${n}.jpg`));
    imgs.forEach(src=>{ const im = new Image(); im.src = src; });
    const aud = cfg.letters.flatMap(l=>l.audio);
    aud.forEach(a=>{ const au = new Audio(); au.src = `assets/audio/${a}`; });
  }

  function current(){ return cfg.letters[state.li]; }
  function imgSrc(){ return `assets/cards/${ current().imgIdx[state.ci] }.jpg`; }
  function updateUI(){
    els.cardImg.src = imgSrc();
    els.cardMeta.textContent = `${current().key} - ${state.ci+1} / 4`;
    els.statusPill.textContent = `${current().key} 学習中`;
    els.bar.style.width = `${((state.ci+1)/4)*100}%`;
    els.letterBadge.textContent = `現在：${current().key}（${current().unlocked?'ロック解除':'ロック中'}）｜次：${ nextLetterLabel() }`;
    els.numBtns.forEach((b,i)=> b.classList.toggle('active', i===state.ci));
  }
  function nextLetterLabel(){
    const n = cfg.letters[state.li+1];
    return n? `${n.key}（${n.unlocked?'ロック解除':'ロック中'}）` : 'なし';
  }

  // --- audio helpers ---
  function playLetter(levelIdx=0){
    const src = `assets/audio/${ current().audio[levelIdx] }`;
    const au = new Audio(src);
    au.play().catch(()=>{});
  }
  function playFinishSfx(){
    try{ els.sfx.currentTime = 0; els.sfx.play().catch(()=>{}); }catch(e){}
  }
  function playMagic(){
    try{ const m = document.getElementById('sfxMagic'); m.currentTime = 0; m.play().catch(()=>{}); }catch(e){}
  }

  function confettiBurst(){
    playMagic();
    const box = els.confetti.getBoundingClientRect();
    for(let i=0;i<60;i++){
      const d = document.createElement('div');
      d.className='dot';
      d.style.left = Math.random()*box.width + 'px';
      d.style.top  = (box.height-10) + 'px';
      d.style.background = `hsl(${Math.random()*360} 80% 60%)`;
      d.style.setProperty('--x', (Math.random()*2-1).toFixed(2));
      d.style.setProperty('--y', (-Math.random()*2-0.5).toFixed(2));
      els.confetti.appendChild(d);
      setTimeout(()=>d.remove(), 900);
    }
  }

  // ---- Event wiring ----
  els.startBtn.addEventListener('click', ()=>{
    show(els.screens.main);
    toast('Aからスタート！');
    updateUI();
  });

  // Number buttons: audio only (no SFX)
  els.numBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = +btn.dataset.idx;
      state.ci = idx;
      btn.classList.add('active');
      // 1→A, 2→AA, 3→AAA, 4→AAAA
      playLetter(idx>3?3:idx);
      updateUI();
    });
  });

  els.prevBtn.addEventListener('click', ()=>{ state.ci = (state.ci+3)%4; updateUI(); });
  els.nextBtn.addEventListener('click', ()=>{ state.ci = (state.ci+1)%4; updateUI(); });

  els.finishBtn.addEventListener('click', ()=>{
    playFinishSfx(); // SFX only here
    if(state.doneThisLetter){ toast('この文字は復習モードです'); return; }
    state.doneThisLetter = true;
    confettiBurst();
    toast(`${current().key} クリア！`);
    // 次の文字をアンロック
    const nxt = cfg.letters[state.li+1];
    if(nxt){ nxt.unlocked = true; save(); }
    updateUI();
  });

  els.resetBtn.addEventListener('click', ()=>{
    localStorage.removeItem('abc_state');
    cfg.letters.forEach((l,i)=> l.unlocked = (i===0));
    state.li=0; state.ci=0; state.doneThisLetter=false; updateUI(); toast('リセットしました');
  });

  // キーボード（1-4, ←/→, n = 次レター）
  window.addEventListener('keydown', (e)=>{
    if(e.key>='1'&&e.key<='4'){ els.numBtns[+e.key-1].click(); }
    if(e.key==='ArrowLeft') els.prevBtn.click();
    if(e.key==='ArrowRight') els.nextBtn.click();
    if(e.key.toLowerCase()==='n') moveLetter(1);
  });

  function moveLetter(step){
    const nl = state.li + step;
    if(nl<0) return;
    const tgt = cfg.letters[nl];
    if(!tgt){ toast('最後の文字です'); return; }
    if(!tgt.unlocked){ toast(`${tgt.key} はロック中`); return; }
    state.li = nl; state.ci=0; state.doneThisLetter=false; save(); updateUI();
  }

  // 画面遷移用ヘルプ（ダブルタップで次のレター）
  els.cardArea.addEventListener('dblclick', ()=> moveLetter(1));

  // 初期化
  load(); preload(); updateUI();
  </script>
</body>
</html>
