<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booha Starter ABC – ブーハABC スターター</title>

  <!-- PWA manifest + install name/icon -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ff4da6">
  <!-- App / install icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="playful-pink-booha.png">
  <link rel="apple-touch-icon" href="playful-pink-booha.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Booha Starter ABC">
  <meta name="application-name" content="Booha Starter ABC">

  <!-- Social preview (tip: use absolute URL on GitHub Pages) -->
  <meta property="og:title" content="Booha Starter ABC">
  <meta property="og:type" content="website">
  <!-- If preview image doesn't show on GH Pages, change to your absolute URL:
       e.g. https://uhibon.github.io/ABC-app/playful-pink-booha.png -->
  <meta property="og:image" content="playful-pink-booha.png">

  <!-- Minimal early fallback -->
  <script>
    function startApp(){
      const hello = document.getElementById('hello');
      if (hello) hello.style.display = 'none';
      const img = document.getElementById('letterImg');
      if (img) { img.src = './1.jpg'; img.alt = 'レター画像'; }
    }
    window.startApp = startApp;
  </script>

  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/cover no-repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.22);z-index:-1}
    #go:target ~ #hello{display:none}

    /* Hello / Start */
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.78);z-index:10}
    .hello-card{position:relative;z-index:11;background:#fff;border-radius:20px;padding:24px;max-width:480px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:140px;height:auto;margin:0 auto;display:block}
    .hello-card h1{margin:12px 0 6px;font-size:24px;line-height:1.2}
    .hello-card p{margin:8px 0;font-size:14px;color:#444}
    .start-link{
      display:inline-block;margin-top:16px;padding:12px 20px;font-size:18px;font-weight:900;text-decoration:none;
      background:#ff4da6;color:#fff;border-radius:14px;box-shadow:0 10px 18px rgba(255,77,166,.28);cursor:pointer
    }
    .start-link:active{transform:scale(.98)}

    /* Top bar */
    .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 16px}
    .left{display:flex;align-items:center;gap:12px}
    .azwrap{display:flex;align-items:center;gap:8px}
    .azlabel{font-size:12px;font-weight:800;color:#333;min-width:1.2em;text-align:center}
    .azmeter{width:200px}
    .bar{height:10px;background:#ffd1e6;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
    .bar>i{display:block;height:100%;background:#ff4da6;width:0%}

    .where{font-weight:800;min-width:1.5em;text-align:center}

    .right{display:flex;flex-direction:column;gap:6px;align-items:stretch;min-width:280px}
    .lockline{font-size:12px;color:#111;display:flex;align-items:center;gap:6px;font-weight:900}
    .clock{font-variant-numeric:tabular-nums}
    .lockmeter{position:relative;height:16px;border-radius:999px;background:linear-gradient(90deg,#f1f5f9,#e2e8f0);box-shadow:inset 0 1px 2px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);overflow:hidden}
    .lockmeter i{position:absolute;left:0;top:0;height:100%;width:0%;background:#7c3aed;transition:width .6s}
    .lock-unlocked{color:#16a34a;font-weight:900}

    /* Letter screen */
    .letter-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 108px);padding:16px;gap:16px;text-align:center}
    .card-wrap{position:relative;display:grid;place-items:center;width:min(900px,96vw);min-height:40vh}
    .card-wrap img{max-width:100%;max-height:70vh;object-fit:contain;border-radius:12px;box-shadow:none}
    .placeholder{position:absolute;inset:auto 12px 12px 12px;background:rgba(255,255,255,.9);border-radius:12px;padding:8px 10px;font-size:12px;color:#333}

    .buttons{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:12px;width:min(680px,92vw)}
    .btn-audio{display:flex;flex-direction:column;align-items:center;gap:6px;border:0;border-radius:18px;padding:16px 18px;font-size:18px;font-weight:900;color:#fff;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.20);transition:transform .12s, background .12s, opacity .12s}
    .btn-audio .num{font-size:26px}
    .btn1{background:#ff5959}.btn2{background:#06b6d4}.btn3{background:#ffd166;color:#111}.btn4{background:#7c5cff}
    .btn-audio:active{transform:scale(.94)}
    .btn1.done{background:#ff7a7a}
    .btn2.done{background:#16c1de}
    .btn3.done{background:#ffe08c;color:#111}
    .btn4.done{background:#9a86ff}
    .btn-audio.done::after{content:" ✓";font-weight:900;font-size:14px;margin-left:4px}
    .btn-audio[disabled]{opacity:.45;cursor:not-allowed;transform:none;pointer-events:none}

    .btn-finish{margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;box-shadow:0 10px 18px rgba(0,0,0,.18)}
    .btn-finish:active{transform:scale(.96)}

    /* Letter nav */
    .nav{position:fixed;left:0;right:0;bottom:10px;display:flex;gap:10px;justify-content:center;z-index:40;visibility:hidden;opacity:0;transition:opacity .2s}
    .nav.show{visibility:visible;opacity:1}
    .nbtn{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer}
    .nbtn:active{transform:scale(.98)}

    canvas#confettiFinish{position:fixed;inset:0;pointer-events:none;z-index:50}
    canvas#confettiQuiz{position:fixed;inset:0;pointer-events:none;z-index:200}

    /* TEST PAGE (auto only) */
    #test{position:fixed;inset:0;z-index:80;display:none}
    #test.active{display:block}
    .t-back{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .t-card{position:relative;z-index:81;background:#fff;border-radius:20px;max-width:900px;margin:6vh auto;padding:16px 16px 18px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
    .t-title{margin:6px 0 2px;font-size:24px}
    .t-prompt{margin:4px 0 12px;color:#444}
    .t-ctrl{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .t-grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .t-item{background:#f7f7fb;border:2px solid transparent;border-radius:14px;padding:8px;display:grid;place-items:center;cursor:pointer;transition:transform .1s, border-color .12s}
    .t-item img{width:100%;height:170px;object-fit:contain}
    .t-item:active{transform:scale(.98)}
    .t-item.correct{border-color:#22c55e}
    .t-item.wrong{border-color:#ef4444}
    .t-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .t-btn{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer}
    .t-ok{background:#28a745}
    .t-progress{font-weight:800}
    .t-hint{display:none}
    @media (max-width:820px){.t-grid{grid-template-columns:repeat(2,1fr)}.t-item img{height:140px}}
  </style>
</head>
<body>
  <div id="go"></div>
  <div class="bg"></div>
  <div class="overlay"></div>

  <!-- Start / Hello -->
  <div id="hello" class="hello" aria-live="polite">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>スターターアプリへようこそ！</h1>
      <p>このアプリをホーム画面に追加してください。</p>
      <p>次の文字は <strong>24時間後</strong> にアンロックされます！</p>
      <a class="start-link" href="#go" onclick="startAppFull();">スタート</a>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="left">
      <div class="azwrap" aria-label="AからZまでの進捗">
        <span class="azlabel">A</span>
        <div class="azmeter"><div class="bar"><i id="azFill"></i></div></div>
        <span class="azlabel">Z</span>
      </div>
      <div id="where" class="where" aria-live="polite">A</div>
    </div>

    <div class="right">
      <div class="lockline">
        <span id="lockStatus"><span class="clock">24:00:00</span> 後にアンロック</span>
      </div>
      <div class="lockmeter"><i id="lockFill"></i></div>
    </div>
  </div>

  <!-- Letter screen -->
  <div class="letter-screen">
    <div class="card-wrap">
      <img id="letterImg" src="./1.jpg" alt="レター画像" />
      <div id="placeholder" class="placeholder" style="display:none"></div>
    </div>
    <div class="buttons">
      <button id="btn1" class="btn-audio btn1"><span class="num">①</span><small>リピート</small></button>
      <button id="btn2" class="btn-audio btn2"><span class="num">②</span><small>いっしょに読む</small></button>
      <button id="btn3" class="btn-audio btn3"><span class="num">③</span><small>リピート</small></button>
      <button id="btn4" class="btn-audio btn4"><span class="num">④</span><small>スペシャル！</small></button>
    </div>
    <button id="finishBtn" class="btn-finish">できた！</button>
  </div>

  <!-- Letter nav (appears after B unlocks) -->
  <div class="nav" id="nav">
    <button id="prev" class="nbtn">◀︎</button>
    <button id="next" class="nbtn">▶︎</button>
  </div>

  <canvas id="confettiFinish"></canvas>
  <canvas id="confettiQuiz"></canvas>

  <!-- SFX -->
  <audio id="clickAudio" src="assets/sfx/click.mp3" preload="auto" playsinline></audio>
  <audio id="magicAudio" src="assets/sfx/magic.mp3" preload="auto" playsinline></audio>

  <!-- TEST PAGE (auto milestones only) -->
  <div id="test">
    <div class="t-back"></div>
    <div class="t-card">
      <h2 class="t-title">テスト</h2>
      <p class="t-prompt">音声を聞いて、正しい<strong>文字</strong>をえらぼう！</p>
      <div class="t-ctrl">
        <button id="tPlay" class="t-btn">▶︎ 再生</button>
        <span id="tHint" class="t-hint"></span>
      </div>
      <div id="tGrid" class="t-grid"></div>
      <div class="t-bottom">
        <div id="tProgress" class="t-progress">1 / 1</div>
        <button id="tClose" class="t-btn t-ok" style="display:none">OK</button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <script>
    /* ---------- PWA: register service worker ---------- */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      });
    }

    /* ---------- Audio (mobile-friendly + speech fallback) ---------- */
    let activeAudio = null;
    let audioCtx = null;
    function ensureAudioCtx(){
      try{
        if ('AudioContext' in window || 'webkitAudioContext' in window){
          audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
          if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
        }
      }catch(e){}
      return audioCtx;
    }
    document.addEventListener('touchstart', ensureAudioCtx, {once:true, passive:true});
    document.addEventListener('click', ensureAudioCtx, {once:true});
    function stopActive(){ try{ if(activeAudio){ activeAudio.pause(); activeAudio.currentTime = 0; } }catch(e){} activeAudio = null; }
    function speakFallback(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
      }catch(e){}
    }
    function playSound(src, gain=1){
      stopActive();
      try{
        const el = new Audio(src);
        el.preload = 'auto';
        el.playsInline = true; el.setAttribute('playsinline','');
        el.addEventListener('error', ()=>{ // audio missing -> say the letter(s)
          const letters = src.split('/').pop().replace('.m4a','');
          speakFallback(letters.split('').join(' '));
        }, {once:true});
        activeAudio = el;
        const ctx = ensureAudioCtx();
        if (ctx){
          try{
            const node = ctx.createMediaElementSource(el);
            const g = ctx.createGain(); g.gain.value = gain;
            node.connect(g).connect(ctx.destination);
          }catch{ el.volume = Math.min(1, gain); }
        }else{ el.volume = Math.min(1, gain); }
        el.play().catch(()=>{});
      }catch(e){}
    }
    window.addEventListener('pagehide', stopActive);
    window.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopActive(); });

    /* ---------- Constants & DOM ---------- */
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const MAX_IDX = 25; // 0..25

    // LocalStorage keys
    const LS_KEY_DONE = "abc_done_letters";
    const LS_KEY_LAST_TEST = "abc_last_test_m";
    const LS_KEY_UNLOCK_IDX = "abc_unlock_idx";
    const LS_KEY_NEXT_UNLOCK = "abc_next_unlock_ms";

    // DOM
    const azFill = document.getElementById("azFill");
    const where = document.getElementById("where");
    const letterImg = document.getElementById("letterImg");
    const placeholder = document.getElementById("placeholder");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const finishBtn = document.getElementById("finishBtn");
    const clickAudio = document.getElementById("clickAudio");
    const lockStatus = document.getElementById("lockStatus");
    const lockFill = document.getElementById("lockFill");
    const nav = document.getElementById("nav");
    const prev = document.getElementById("prev");
    const next = document.getElementById("next");

    const test = document.getElementById("test");
    const tGrid = document.getElementById("tGrid");
    const tPlay = document.getElementById("tPlay");
    const tHint = document.getElementById("tHint");
    const tClose = document.getElementById("tClose");
    const tProgress = document.getElementById("tProgress");

    /* ---------- App state ---------- */
    let letterIdx = 0; // 0=A
    let doneList = loadDoneList();
    let doneSet = new Set(doneList);
    let unlockIdx = ensureNumber(LS_KEY_UNLOCK_IDX, 0);         // newest unlocked index (A at first)
    let nextUnlockMs = ensureNumber(LS_KEY_NEXT_UNLOCK, 0);     // 0 until you finish newest
    let step = 1; // 1..5 (⑤ means ready for Finish)

    // ensure initial keys exist (avoids "undefined" first-run weirdness)
    function ensureNumber(key, def){
      const raw = localStorage.getItem(key);
      if (raw === null || raw === undefined){ localStorage.setItem(key, String(def)); return def; }
      const n = Number(raw); return Number.isFinite(n) ? n : def;
    }

    /* ---------- Helpers ---------- */
    function loadDoneList(){
      try{ const raw = JSON.parse(localStorage.getItem(LS_KEY_DONE) || "[]"); return Array.isArray(raw) ? raw : []; }
      catch{ return []; }
    }
    function saveDone(){ try{ localStorage.setItem(LS_KEY_DONE, JSON.stringify(doneList)); }catch{} }
    function saveNumber(key, val){ try{ localStorage.setItem(key, String(val)); }catch{} }

    function getCardBase(i){ return i*4; }
    function firstCardSrc(idx){ return `./${getCardBase(idx)+1}.jpg`; }
    function showCard(n){
      const base = getCardBase(Math.min(letterIdx, MAX_IDX));
      const num = base + n; // 1..4
      const src = `./${num}.jpg`;
      letterImg.src = src;
      letterImg.alt = `レター画像`;
      // image fallback message
      letterImg.onerror = ()=>{
        placeholder.style.display = 'block';
        placeholder.textContent = `画像が見つかりません: ${src}
置き方: A=1-4.jpg, B=5-8.jpg, ... Z=101-104.jpg`;
      };
      letterImg.onload = ()=>{ placeholder.style.display = 'none'; };
    }

    /* ----- UI updates ----- */
    function updateAZMeter(){
      // meter shows how far we've UNLOCKED (A..current unlocked)
      const pct = (unlockIdx / MAX_IDX) * 100;
      azFill.style.width = pct + "%";
    }
    function updateWhere(){ where.textContent = letters[letterIdx]; }
    function msToHMS(ms){
      const s = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
    function updateCountdownUI(){
      if (unlockIdx >= MAX_IDX){
        lockStatus.innerHTML = `<span class="lock-unlocked">✅ <strong>全ての文字がアンロック済み</strong></span>`;
        lockFill.style.width = '100%';
        return;
      }
      if (nextUnlockMs > 0){
        const remaining = Math.max(0, nextUnlockMs - Date.now());
        const total = 24*60*60*1000;
        const pct = Math.min(1, 1 - (remaining / total));
        lockFill.style.width = (pct*100).toFixed(1) + '%';
        const hhmmss = msToHMS(remaining);
        lockStatus.innerHTML = `<span class="clock">${hhmmss}</span> 後にアンロック`;
      }else{
        lockFill.style.width = '0%';
        lockStatus.innerHTML = `<span class="clock">24:00:00</span> 後にアンロック`;
      }
    }
    function refreshUnlocks(){
      // unlock only when timer reaches zero (strict)
      if (nextUnlockMs > 0 && Date.now() >= nextUnlockMs && unlockIdx < MAX_IDX){
        unlockIdx = Math.min(unlockIdx + 1, MAX_IDX);
        nextUnlockMs = 0;
        saveNumber(LS_KEY_UNLOCK_IDX, unlockIdx);
        saveNumber(LS_KEY_NEXT_UNLOCK, nextUnlockMs);
        if (unlockIdx >= 1) nav.classList.add('show'); // show arrows after B unlocks
      }
      updateTop();
    }

    function updateTop(){
      updateWhere();
      updateAZMeter();
      updateCountdownUI();
      if (unlockIdx >= 1) nav.classList.add('show'); else nav.classList.remove('show');

      // Finish button appears only if:
      // - steps ①②③④ are completed in order (step==5),
      // - and this is the newest unlocked letter,
      // - and letter not already finished.
      const L = letters[letterIdx];
      const isNewest = (letterIdx === unlockIdx);
      const canShowFinish = (step === 5) && isNewest && !doneSet.has(L);
      finishBtn.style.display = canShowFinish ? 'inline-block' : 'none';
    }

    function clampToUnlocked(i){
      const limit = unlockIdx; // HARD cap
      return Math.max(0, Math.min(i, limit));
    }

    function resetButtons(){
      [btn1,btn2,btn3,btn4].forEach(b=>{ b.classList.remove('done'); b.disabled = true; });
      btn1.disabled = false; // start with ①
    }

    function advanceStep(validButton, expectedStep){
      if (step !== expectedStep) return; // enforce exact order
      validButton.classList.add('done');
      validButton.disabled = true;
      step++;
      if (step === 2) btn2.disabled = false;
      if (step === 3) btn3.disabled = false;
      if (step === 4) btn4.disabled = false;
      // after ④ -> step becomes 5
      updateTop();
    }

    function playClick(){ try{ clickAudio.currentTime=0; clickAudio.play().catch(()=>{});}catch{} }
    function playLetterTimes(times){
      const L = letters[letterIdx];
      const name = L.repeat(times); // "A","AA","AAA","AAAA"
      const src = `assets/audio/${name}.m4a`;
      playSound(src, 1);
    }
    function playLetterCueByIndex(idx){
      const L = letters[idx];
      const src = `assets/audio/${L}.m4a`;
      playSound(src, 1.0);
    }

    function firstUnfinishedUnlocked(){
      for (let i=0;i<=unlockIdx;i++){
        if (!doneSet.has(letters[i])) return i;
      }
      return clampToUnlocked(letterIdx);
    }

    function onEnterLetter(){
      const L = letters[letterIdx];
      step = 1;
      showCard(1);
      resetButtons();
      if (doneSet.has(L)) {
        // already finished → no replaying steps, no Finish
        [btn1,btn2,btn3,btn4].forEach(b => b.disabled = true);
      }
      updateTop();
    }

    /* ---------- Start ---------- */
    function startAppFull(){
      startApp();
      refreshUnlocks();
      letterIdx = clampToUnlocked(firstUnfinishedUnlocked());
      onEnterLetter();
    }
    window.startAppFull = startAppFull;
    if(location.hash === '#go'){ startAppFull(); }

    /* ---------- Button handlers (strict order) ---------- */
    btn1.addEventListener('click', ()=>{
      if (btn1.disabled) return;
      ensureAudioCtx(); showCard(1); playLetterTimes(1);
      advanceStep(btn1, 1);
    }, {passive:true});
    btn2.addEventListener('click', ()=>{
      if (btn2.disabled) return;
      ensureAudioCtx(); showCard(2); playLetterTimes(2);
      advanceStep(btn2, 2);
    }, {passive:true});
    btn3.addEventListener('click', ()=>{
      if (btn3.disabled) return;
      ensureAudioCtx(); showCard(3); playLetterTimes(3);
      advanceStep(btn3, 3);
    }, {passive:true});
    btn4.addEventListener('click', ()=>{
      if (btn4.disabled) return;
      ensureAudioCtx(); showCard(4); playLetterTimes(4);
      advanceStep(btn4, 4);
    }, {passive:true});

    /* ---------- Finish & gating ---------- */
    function startFinishConfetti(duration=3000){
      const cFinish = document.getElementById("confettiFinish");
      const xFinish = cFinish.getContext("2d");
      function resize(){ cFinish.width = innerWidth; cFinish.height = innerHeight; }
      resize(); window.addEventListener('resize', resize, {once:true});
      let running = true;
      const pieces = Array.from({length:280}).map(()=>({
        x: Math.random()*cFinish.width, y: -Math.random()*cFinish.height,
        r: Math.random()*8+3, vy: Math.random()*2+1.5,
        color: `hsl(${Math.random()*360},100%,55%)`
      }));
      const end = Date.now() + duration;
      (function draw(){
        xFinish.clearRect(0,0,cFinish.width,cFinish.height);
        for(const p of pieces){
          xFinish.beginPath(); xFinish.arc(p.x,p.y,p.r,0,2*Math.PI);
          xFinish.fillStyle = p.color; xFinish.fill();
          p.y += p.vy*2.1; if(p.y>cFinish.height+12){ p.y = -10; p.x = Math.random()*cFinish.width; }
        }
        if(Date.now()<end && running) requestAnimationFrame(draw);
        else { xFinish.clearRect(0,0,cFinish.width,cFinish.height); running=false; }
      })();
    }

    finishBtn.onclick = ()=>{
      playClick();
      const L = letters[letterIdx];
      if (doneSet.has(L)) return; // once per letter

      doneSet.add(L);
      doneList.push(L);
      saveDone();

      playSound('assets/sfx/magic.mp3', 1.5);
      startFinishConfetti(3000);

      finishBtn.style.display='none';
      [btn1,btn2,btn3,btn4].forEach(b=> b.disabled = true);

      // start strict 24h timer only when finishing newest letter (and not Z)
      if (letterIdx === unlockIdx && unlockIdx < MAX_IDX){
        nextUnlockMs = Date.now() + 24*60*60*1000;
        saveNumber(LS_KEY_NEXT_UNLOCK, nextUnlockMs);
      }

      // Completed Z
      if (letterIdx === MAX_IDX){
        letterImg.src = './finished.jpg';
        letterImg.alt = 'FINISHED!';
        updateTop();
        return;
      }

      // Milestone test every 5 (E J O T Y) – optional: keep if you want
      const groupsDone = Math.floor(doneSet.size / 5);
      const last = Number(localStorage.getItem(LS_KEY_LAST_TEST) || 0);
      if (doneSet.size>0 && doneSet.size%5===0 && groupsDone>last && doneSet.size<26){
        localStorage.setItem(LS_KEY_LAST_TEST, String(groupsDone));
        openTest();
      }

      updateTop();
    };

    /* ---------- Nav (clamped to unlocked) ---------- */
    prev.onclick = ()=>{
      letterIdx = Math.max(0, letterIdx-1);
      onEnterLetter();
    };
    next.onclick = ()=>{
      letterIdx = Math.min(unlockIdx, letterIdx+1); // cannot pass locked boundary
      onEnterLetter();
    };

    /* ---------- Live countdown + unlock polling ---------- */
    setInterval(refreshUnlocks, 1000);
    window.addEventListener('focus', refreshUnlocks);

    /* ---------- Quiz (short) ---------- */
    function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
    function startQuizConfetti(duration = 3000){
      const c = document.getElementById("confettiQuiz");
      const x = c.getContext("2d");
      c.style.zIndex = '200';
      function resize(){ c.width = innerWidth; c.height = innerHeight; }
      resize(); window.addEventListener('resize', resize, {once:true});
      let items=[], start=Date.now();
      function emit(n=120){
        for(let i=0;i<n;i++){
          const a=Math.random()*Math.PI*2,s=Math.random()*4+2.8;
          items.push({x:c.width/2,y:c.height/2,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:700+Math.random()*900,r:Math.random()*6+3});
        }
      }
      emit(200);
      const iv=setInterval(()=>{ if(Date.now()-start<duration) emit(100); else clearInterval(iv);},420);
      (function draw(){
        const t=Date.now()-start; x.clearRect(0,0,c.width,c.height);
        for(const it of items){ it.x+=it.vx; it.y+=it.vy; it.vy+=0.05; it.life-=16;
          x.fillStyle='#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0');
          x.beginPath(); x.arc(it.x,it.y,it.r,0,Math.PI*2); x.fill();
        }
        items=items.filter(it=>it.life>0&&it.x>-60&&it.x<c.width+60&&it.y<c.height+60);
        if(t<duration+300){ requestAnimationFrame(draw);} else { x.clearRect(0,0,c.width,c.height); }
      })();
    }
    function openTest(){
      const recent = doneList.slice(-5).map(L => letters.indexOf(L)).filter(i => i>=0 && i<=MAX_IDX);
      let pool = recent.length >= 4 ? recent : Array.from({length:(unlockIdx+1)}, (_,i)=>i);
      pool = shuffle(pool).slice(0,4);

      const correctIdx = pool[Math.floor(Math.random()*pool.length)];
      const renderOrder = shuffle([...pool]);

      tGrid.innerHTML = '';
      for(const idx of renderOrder){
        const btn = document.createElement('button');
        btn.type='button'; btn.className='t-item';
        const img = document.createElement('img');
        img.src = firstCardSrc(idx);
        img.alt = 'えらぶレター';
        btn.appendChild(img);
        btn.onclick = ()=>{
          const ok = idx === correctIdx;
          btn.classList.add(ok?'correct':'wrong');
          if(ok){
            playSound('assets/sfx/cheer.mp3', 1.0);
            [...tGrid.querySelectorAll('.t-item')].forEach(b=>b.disabled=true);
            startQuizConfetti(3000);
            tClose.style.display = 'inline-block';
          }else{
            setTimeout(()=> btn.classList.remove('wrong'), 380);
          }
        };
        tGrid.appendChild(btn);
      }

      tPlay.onclick = ()=> playLetterCueByIndex(correctIdx);
      if(tHint){ tHint.textContent = ''; }
      tClose.style.display = 'none';
      tProgress.textContent = '1 / 1';
      test.classList.add('active');
      playLetterCueByIndex(correctIdx);

      const backdropClose = (e)=>{ if(e.target.classList.contains('t-back')) closeTest(); };
      test.addEventListener('click', backdropClose, {once:true});
      tClose.onclick = closeTest;
    }
    function closeTest(){ test.classList.remove('active'); stopActive(); }
  </script>
</body>
</html>
