<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブーハABC (A+B test)</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/cover no-repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.22);z-index:-1}

    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.7);z-index:10}
    .hello-card{background:#fff;border-radius:20px;padding:24px;text-align:center;max-width:420px;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:120px;height:120px;object-fit:contain}
    .hello-card h1{margin:12px 0 6px;font-size:27px;line-height:1.05}
    .hello-card p{margin:4px 0;font-size:13px;color:#444}
    .hello-card button{margin-top:16px;padding:12px 20px;font-size:18px;font-weight:bold;background:#111;color:#fff;border:0;border-radius:14px;cursor:pointer}

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    .progress{flex:1;margin-right:12px}
    .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:#111;width:0%}
    .countdown{font-size:14px;color:#333}

    .letter-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 80px);padding:16px;text-align:center;gap:16px}
    .card-wrap{
      display:grid;place-items:center;
      width:min(900px, 96vw);
      min-height:40vh;
      background:#fff;border-radius:22px;border:1px solid #e7e9ef;
      box-shadow:0 16px 32px rgba(0,0,0,.18), 0 1px 0 rgba(255,255,255,.8) inset;
      padding:8px;
    }
    .card-wrap img{max-width:100%;max-height:70vh;width:auto;height:auto;object-fit:contain;border-radius:14px;}

    .buttons{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:12px;width:min(680px, 92vw)}
    .btn-audio{
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      border:0;border-radius:18px;padding:16px 18px;
      font-size:18px;font-weight:900;color:#fff;cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.20);
      transition: transform 0.15s ease, background-color .12s ease;
    }
    .btn-audio:active{transform:scale(0.92)}
    .btn-audio.pressed{background:#7c5cff !important; color:#fff}
    .btn-audio .num{font-size:26px;line-height:1}
    .btn-audio small{font-weight:700;font-size:12px;opacity:.95}
    .btn1{background:#ff5959}
    .btn2{background:#06b6d4}
    .btn3{background:#ffd166;color:#111}
    .btn4{background:#7c5cff}
    .btn-audio[disabled]{opacity:.65;cursor:default}

    .btn-finish{
      margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;
      font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
    }
    .btn-finish:active{transform:scale(0.92)}
    .btn-finish.pressed{background:#7c5cff}

    canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:50}

    /* Dev/test controls */
    .dev-tools{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;z-index:9999}
    .dev-tools button{
      background:#111;color:#fff;border:0;border-radius:12px;
      padding:8px 12px;font-size:12px;font-weight:800;opacity:.85;cursor:pointer
    }
    .dev-tools button:hover{opacity:1}
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <div id="hello" class="hello">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>こんにちは！</h1>
      <p>スタートすると、毎日１つの文字が解放されます。</p>
      <p>進捗を守るため、同じ端末をご使用ください。</p>
      <button id="startBtn">スタート</button>
    </div>
  </div>

  <div class="topbar">
    <div class="progress"><div class="bar"><i id="barFill"></i></div></div>
    <div id="countdown" class="countdown">—:—:—</div>
  </div>

  <div class="letter-screen">
    <div class="card-wrap">
      <img id="cardImg" src="./1.jpg" alt="カード1" />
    </div>
    <div class="buttons">
      <button id="btn1" class="btn-audio btn1"><span class="num">①</span><small>リピート</small></button>
      <button id="btn2" class="btn-audio btn2"><span class="num">②</span><small>いっしょに読む</small></button>
      <button id="btn3" class="btn-audio btn3"><span class="num">③</span><small>リピート</small></button>
      <button id="btn4" class="btn-audio btn4"><span class="num">④</span><small>スペシャル！</small></button>
    </div>
    <button id="finishBtn" class="btn-finish">できた！</button>
  </div>

  <!-- Dev/test controls -->
  <div class="dev-tools">
    <button id="devReset">リセット</button>
    <button id="devUnlock">全解放</button>
    <button id="devPrev">◀ Prev</button>
    <button id="devNext">Next ▶</button>
  </div>

  <canvas id="confetti"></canvas>

  <script>
    const MS_DAY = 24*60*60*1000;
    const LS_KEY_START = "abc_start_ts";
    const LS_KEY_DONE  = "abc_done_letters";

    // LIMIT TO A & B ONLY
    const letters = ["A","B"];
    const TOTAL_LETTERS = letters.length; // 2

    // --- DOM
    const hello = document.getElementById("hello");
    const startBtn = document.getElementById("startBtn");
    const barFill = document.getElementById("barFill");
    const countdown = document.getElementById("countdown");
    const cardImg = document.getElementById("cardImg");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const finishBtn = document.getElementById("finishBtn");
    const devReset = document.getElementById("devReset");
    const devUnlock = document.getElementById("devUnlock");
    const devNext = document.getElementById("devNext");
    const devPrev = document.getElementById("devPrev");

    // --- State
    let startTs = localStorage.getItem(LS_KEY_START)?Number(localStorage.getItem(LS_KEY_START)):null;
    let doneSet = loadDoneSet();
    let activeIndex = 0;   // 0=A, 1=B
    let audioStep = 0;     // 0→1→2→3→4
    let confettiRunning = false;

    // --- SFX (shared Audio) + per-button files
    const sfxEl = new Audio();
    const clickSounds = {
      "1": { m4a: "assets/sfx/click.m4a",  mp3: "assets/sfx/click.mp3" },
      "2": { m4a: "assets/sfx/click1.m4a", mp3: "assets/sfx/click1.mp3" },
      "3": { m4a: "assets/sfx/click2.m4a", mp3: "assets/sfx/click2.mp3" },
      "4": { m4a: "assets/sfx/click3.m4a", mp3: "assets/sfx/click3.mp3" },
      "finish": { m4a: "assets/sfx/click4.m4a", mp3: "assets/sfx/click4.mp3" }
    };

    // SFX then short delay (120ms) after it ends; safety cap if no 'ended'.
    function playUISoundThenDelay(key){
      return new Promise((resolve)=>{
        const files = clickSounds[key];
        if(!files){ setTimeout(resolve,120); return; }
        try{sfxEl.pause();}catch(e){}
        sfxEl.currentTime = 0;

        const canMp4 = !!sfxEl.canPlayType && sfxEl.canPlayType("audio/mp4");
        const bust = `?v=${Date.now().toString().slice(-6)}`;
        const order = canMp4 ? [files.m4a+bust, files.mp3+bust] : [files.mp3+bust, files.m4a+bust];
        let i = 0;

        function doneAfterDelay(){ setTimeout(resolve, 120); } // 0.12s after SFX end
        function tryPlay(){
          if(i>=order.length){ doneAfterDelay(); return; }
          sfxEl.src = order[i++];
          sfxEl.currentTime = 0;
          const cap = setTimeout(doneAfterDelay, 900); // short cap for click sounds
          sfxEl.onended = () => { clearTimeout(cap); doneAfterDelay(); };
          const p = sfxEl.play();
          if(p && typeof p.catch === "function") p.catch(()=>{ tryPlay(); });
        }
        sfxEl.onerror = ()=>{ tryPlay(); };
        tryPlay();
      });
    }

    // --- Start flow
    startBtn.onclick = () => {
      if(!startTs){ startTs = Date.now(); localStorage.setItem(LS_KEY_START, startTs); }
      hello.style.display = "none";
      renderForActiveIndex(calcActiveIndexFromUnlock());
    };

    // Helpers (storage)
    function loadDoneSet(){
      try { const raw = localStorage.getItem(LS_KEY_DONE); return new Set(raw ? JSON.parse(raw) : []); }
      catch { return new Set(); }
    }
    function saveDoneSet(){ localStorage.setItem(LS_KEY_DONE, JSON.stringify([...doneSet])); }

    // Unlock & time (clamped to 2 letters)
    function getUnlockedCount(){
      if(!startTs) return 0;
      const days = Math.floor((Date.now() - startTs) / MS_DAY);
      return Math.min(TOTAL_LETTERS, Math.max(1, days + 1));
    }
    function nextUnlockMs(){
      if(!startTs) return null;
      const unlocked = getUnlockedCount();
      if(unlocked >= TOTAL_LETTERS) return 0;
      return (startTs + unlocked*MS_DAY) - Date.now();
    }
    function fmt(ms){ if(ms==null) return "—:—:—";
      const s=Math.floor(ms/1000), h=String(Math.floor(s/3600)).padStart(2,"0"),
            m=String(Math.floor((s%3600)/60)).padStart(2,"0"), ss=String(s%60).padStart(2,"0");
      return `${h}:${m}:${ss}`;
    }
    function calcActiveIndexFromUnlock(){ return getUnlockedCount() - 1; }

    // --- Rendering (per activeIndex)
    function renderForActiveIndex(newIndex){
      activeIndex = Math.max(0, Math.min(TOTAL_LETTERS-1, newIndex)); // 0..1
      barFill.style.width = ((activeIndex+1)/TOTAL_LETTERS*100) + "%";
      setCard(1);

      const L = letters[activeIndex];
      if (doneSet.has(L)){
        audioStep = 4;
        setAllButtonsEnabled(true);
        finishBtn.style.display = "none";
      } else {
        audioStep = 0;
        setButtonStates();
        finishBtn.style.display = "none";
      }
    }

    // Mapping: A=1–4, B=5–8
    function setCard(step){
      const imgNum = activeIndex*4 + step; // 1..8
      cardImg.src = `./${imgNum}.jpg`;
      cardImg.alt = `カード${imgNum}`;
    }

    function setAllButtonsEnabled(on){ [btn1,btn2,btn3,btn4].forEach(b=>b.disabled=!on); }
    function setButtonStates(){
      btn1.disabled = !(audioStep === 0);
      btn2.disabled = !(audioStep === 1);
      btn3.disabled = !(audioStep === 2);
      btn4.disabled = !(audioStep === 3);
    }

    // Lesson audio (single at a time)
    let currentLessonEl = null;
    function playLesson(step){
      if(currentLessonEl){ try{ currentLessonEl.pause(); }catch(e){} currentLessonEl = null; }
      const L = letters[activeIndex];
      const name = L.repeat(step); // A, AA, AAA, AAAA or B...
      const files = { m4a:`assets/audio/${name}.m4a`, mp3:`assets/audio/${name}.mp3` };
      const el = new Audio(); currentLessonEl = el;
      const canMp4 = !!el.canPlayType && el.canPlayType("audio/mp4");
      const bust = `?v=${Date.now().toString().slice(-6)}`;
      const order = canMp4 ? [files.m4a+bust, files.mp3+bust] : [files.mp3+bust, files.m4a+bust];
      let i=0;
      function tryPlay(){
        if(i>=order.length) return;
        el.src = order[i++]; el.currentTime=0;
        const p = el.play();
        if(p && typeof p.catch==="function") p.catch(()=>{ tryPlay(); });
      }
      el.onerror = ()=>{ tryPlay(); };
      tryPlay();
    }

    function flashPressed(el){ el.classList.add("pressed"); setTimeout(()=>el.classList.remove("pressed"),150); }

    // --- Button handlers: SFX → ~0.12s → Lesson
    btn1.onclick = async () => {
      flashPressed(btn1);
      if(audioStep>0 && audioStep<4) return;
      setCard(1);
      await playUISoundThenDelay("1");
      playLesson(1);
      if(audioStep===0){ audioStep=1; setButtonStates(); }
    };
    btn2.onclick = async () => {
      flashPressed(btn2);
      if(doneSet.has(letters[activeIndex])){ setCard(2); await playUISoundThenDelay("2"); playLesson(2); return; }
      if(audioStep!==1) return;
      setCard(2);
      await playUISoundThenDelay("2");
      playLesson(2);
      audioStep=2; setButtonStates();
    };
    btn3.onclick = async () => {
      flashPressed(btn3);
      if(doneSet.has(letters[activeIndex])){ setCard(3); await playUISoundThenDelay("3"); playLesson(3); return; }
      if(audioStep!==2) return;
      setCard(3);
      await playUISoundThenDelay("3");
      playLesson(3);
      audioStep=3; setButtonStates();
    };
    btn4.onclick = async () => {
      flashPressed(btn4);
      if(doneSet.has(letters[activeIndex])){ setCard(4); await playUISoundThenDelay("4"); playLesson(4); return; }
      if(audioStep!==3) return;
      setCard(4);
      await playUISoundThenDelay("4");
      playLesson(4);
      audioStep=4; setButtonStates();
      finishBtn.style.display = "inline-block";
    };

    finishBtn.onclick = async () => {
      flashPressed(finishBtn);
      await playUISoundThenDelay("finish");
      const L = letters[activeIndex];
      if (!doneSet.has(L)){
        startConfetti(4000);
        doneSet.add(L);
        saveDoneSet();
      }
      setAllButtonsEnabled(true);
      finishBtn.style.display = "none";
    };

    // Countdown (clamped for 2-letter test deck)
    function tickCountdown(){
      const ms = nextUnlockMs();
      countdown.textContent = ms === 0 ? "テスト: A+B 全解放" : fmt(ms);
    }
    setInterval(tickCountdown, 1000); tickCountdown();

    // On load
    if(startTs){
      hello.style.display = "none";
      renderForActiveIndex(calcActiveIndexFromUnlock());
    }

    /* ---------- Confetti ---------- */
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    let confetti = [];
    function startConfetti(duration){
      if(confettiRunning) return;
      confettiRunning = true;
      resize();
      confetti = Array.from({length:280}).map(()=>({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height - canvas.height,
        r: Math.random()*7 + 3,
        d: Math.random()*1 + 0.5,
        color: `hsl(${Math.random()*360},100%,50%)`
      }));
      const end = Date.now() + duration;
      (function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        confetti.forEach(p=>{
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,2*Math.PI);
          ctx.fillStyle = p.color; ctx.fill();
        });
        confetti.forEach(p=>{
          p.y += p.d*4;
          if(p.y>canvas.height){ p.y = -10; p.x = Math.random()*canvas.width; }
        });
        if(Date.now() < end){ requestAnimationFrame(draw); }
        else { confettiRunning = false; ctx.clearRect(0,0,canvas.width,canvas.height); }
      })();
    }
    window.onresize = resize;
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    resize();

    /* ---------- Dev/test controls ---------- */
    devReset.onclick = () => {
      localStorage.removeItem(LS_KEY_START);
      localStorage.removeItem(LS_KEY_DONE);
      location.reload();
    };
    devUnlock.onclick = () => {
      const past = Date.now() - 3*MS_DAY; // enough to unlock B
      localStorage.setItem(LS_KEY_START, String(past));
      localStorage.removeItem(LS_KEY_DONE);
      location.reload();
    };
    devNext.onclick = () => { renderForActiveIndex((activeIndex + 1) % TOTAL_LETTERS); };
    devPrev.onclick = () => { renderForActiveIndex((activeIndex - 1 + TOTAL_LETTERS) % TOTAL_LETTERS); };
  </script>
</body>
</html>
