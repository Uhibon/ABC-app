<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booha ABC</title>
  <style>
    body,html{margin:0;padding:0;height:100%;font-family:sans-serif}
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/700px repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.25);z-index:-1}
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.7);z-index:10}
    .hello-card{background:#fff;border-radius:20px;padding:24px;text-align:center;max-width:400px;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:120px}
    .hello-card button{margin-top:16px;padding:12px 20px;font-size:18px;font-weight:bold;background:#111;color:#fff;border:0;border-radius:14px;cursor:pointer}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    .progress{flex:1;margin-right:12px}
    .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:#111;width:0%}
    .countdown{font-size:14px;color:#333}
    .letter-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 80px);padding:20px;text-align:center}
    .big-letter{font-size:20vw;font-weight:900;margin:20px 0}
    .buttons{display:flex;flex-direction:column;gap:12px;width:100%;max-width:340px}
    .btn-audio{padding:16px;border:0;border-radius:16px;font-size:24px;font-weight:bold;cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,.15)}
    .btn-audio small{display:block;font-size:14px;font-weight:normal;color:#333}
    .btn-finish{margin-top:20px;padding:16px;background:#28a745;color:#fff;font-size:22px;font-weight:bold;border:0;border-radius:16px;cursor:pointer;display:none}
    canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:50}
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <!-- Hello screen -->
  <div id="hello" class="hello">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="logo" />
      <h1>こんにちは！</h1>
      <p>スタートすると、毎日１つの文字が解放されます。</p>
      <p>同じ端末を使ってください。</p>
      <button id="startBtn">スタート</button>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="progress"><div class="bar"><i id="barFill"></i></div></div>
    <div id="countdown" class="countdown">—:—:—</div>
  </div>

  <!-- Letter of the day screen -->
  <div class="letter-screen">
    <div id="bigLetter" class="big-letter">A</div>
    <div class="buttons">
      <button id="btn1" class="btn-audio" style="background:#ff6b6b">A<small>リピート</small></button>
      <button id="btn2" class="btn-audio" style="background:#00bcd4">A-A<small>いっしょに読む</small></button>
      <button id="btn3" class="btn-audio" style="background:#ffd166">A-A-A<small>リピート</small></button>
      <button id="btn4" class="btn-audio" style="background:#7c5cff">A-A-A-A<small>スペシャル！</small></button>
    </div>
    <button id="finishBtn" class="btn-finish">できた！</button>
  </div>

  <canvas id="confetti"></canvas>

  <script>
    const MS_DAY = 24*60*60*1000;
    const LS_KEY = "abc_start_ts";
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    let startTs = localStorage.getItem(LS_KEY)?Number(localStorage.getItem(LS_KEY)):null;

    const hello=document.getElementById("hello");
    const startBtn=document.getElementById("startBtn");
    const barFill=document.getElementById("barFill");
    const countdown=document.getElementById("countdown");
    const bigLetter=document.getElementById("bigLetter");
    const btns=[btn1,btn2,btn3,btn4];
    const finishBtn=document.getElementById("finishBtn");

    let activeIndex=0; // current letter index
    let audioStep=0; // track progress through 1..4
    let confettiRunning=false;

    startBtn.onclick=()=>{
      if(!startTs){ startTs=Date.now(); localStorage.setItem(LS_KEY,startTs); }
      hello.style.display="none";
      showLetter();
    };

    function getUnlockedCount(){
      if(!startTs) return 0;
      const elapsed=Date.now()-startTs;
      const days=Math.floor(elapsed/MS_DAY);
      return Math.min(26,Math.max(1,days+1));
    }
    function nextUnlockMs(){
      if(!startTs) return null;
      const unlocked=getUnlockedCount();
      if(unlocked>=26) return 0;
      return (startTs+unlocked*MS_DAY)-Date.now();
    }
    function fmt(ms){
      if(ms==null) return "—:—:—";
      const s=Math.floor(ms/1000);
      const h=String(Math.floor(s/3600)).padStart(2,"0");
      const m=String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss=String(s%60).padStart(2,"0");
      return `${h}:${m}:${ss}`;
    }

    function showLetter(){
      const unlocked=getUnlockedCount();
      activeIndex=unlocked-1; // show today's
      bigLetter.textContent=letters[activeIndex];
      barFill.style.width=(unlocked/26*100)+"%";
      audioStep=0;
      finishBtn.style.display="none";
    }

    function playAudio(step){
      const L=letters[activeIndex];
      let name=L.repeat(step); // A, AA, AAA, AAAA
      let audio=new Audio(`assets/audio/${name}.m4a`);
      audio.play();
    }

    btns.forEach((b,i)=>{
      b.onclick=()=>{
        if(audioStep===i){ // enforce order
          playAudio(i+1);
          audioStep++;
          if(audioStep===4) finishBtn.style.display="block";
        }
      };
    });

    finishBtn.onclick=()=>{
      if(confettiRunning) return;
      startConfetti(4000);
    };

    function updateCountdown(){
      const ms=nextUnlockMs();
      countdown.textContent=ms===0?"すべて解放":fmt(ms);
    }
    setInterval(updateCountdown,1000);
    updateCountdown();

    // simple confetti
    const canvas=document.getElementById("confetti");
    const ctx=canvas.getContext("2d");
    let confetti=[];
    function startConfetti(duration){
      confettiRunning=true;
      resize();
      confetti=Array.from({length:150}).map(()=>({
        x:Math.random()*canvas.width,
        y:Math.random()*canvas.height-canvas.height,
        r:Math.random()*6+4,
        d:Math.random()*0.5+0.5,
        color:`hsl(${Math.random()*360},100%,50%)`
      }));
      let end=Date.now()+duration;
      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        confetti.forEach(p=>{
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,2*Math.PI);
          ctx.fillStyle=p.color;
          ctx.fill();
        });
        confetti.forEach(p=>{
          p.y+=p.d*4;
          if(p.y>canvas.height){p.y=0;p.x=Math.random()*canvas.width;}
        });
        if(Date.now()<end){ requestAnimationFrame(draw); }
        else{ confettiRunning=false; ctx.clearRect(0,0,canvas.width,canvas.height);}
      }
      draw();
    }
    window.onresize=resize;
    function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
    resize();
  </script>
</body>
</html>
