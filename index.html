<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ブーハー ABC スターター</title>

  <!-- App icon -->
  <link rel="icon" type="image/png" sizes="192x192" href="playful-pink-booha.png">
  <link rel="apple-touch-icon" href="playful-pink-booha.png">
  <meta name="theme-color" content="#ff4da6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ブーハABC">

  <!-- Minimal early fallback -->
  <script>
    function startApp(){
      const hello = document.getElementById('hello');
      if (hello) hello.style.display = 'none';
      const img = document.getElementById('letterImg');
      if (img) { img.src = './1.jpg'; img.alt = 'レター画像'; }
    }
    window.startApp = startApp;
  </script>

  <style>
    :root{
      --ink:#1f2328; --muted:#4a5568;
      --pink:#ff4da6;            /* A–Z meter fill */
      --pink-soft:#ffd1e6;
      --purple:#7c5cff;          /* 24h meter fill */
      --purple-soft:#ece9ff;
      --ok:#22c55e; --bad:#ef4444;
    }

    /* === Base === */
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
    body{
      background:url("booha-background.jpg") center/cover fixed no-repeat;
      min-height:100svh;
      overflow:hidden; /* keep whole app visible on mobile */
    }

    /* CSS-only fallback: when #go is targeted, hide hello overlay (works with no JS) */
    #go:target ~ #hello{display:none}

    /* === Hello / Start === */
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.85);z-index:10}
    .hello-card{background:#fff;border-radius:20px;padding:24px;max-width:480px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:140px;height:auto;margin:0 auto;display:block}
    .hello-card h1{margin:12px 0 6px;font-size:24px;line-height:1.2}
    .hello-card p{margin:8px 0;font-size:14px;color:#444}
    .start-link{
      display:inline-block;margin-top:16px;padding:12px 20px;font-size:18px;font-weight:900;text-decoration:none;
      background:#ff4da6;color:#fff;border-radius:14px;box-shadow:0 10px 18px rgba(255,77,166,.28);cursor:pointer
    }
    .start-link:active{transform:scale(.98)}

    /* === Top bar: left (A–Z), center (logo), right (24h) === */
    .topbar{
      display:grid;grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);align-items:center;
      gap:16px;padding:10px 16px;max-width:1200px;margin:0 auto;
    }

    /* A–Z progress (pink) on the left with A/Z labels only */
    .progress{width:100%}
    .progress .labels{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-weight:800;color:var(--ink);
    }
    /* height matched to lockmeter for visual parity */
    .bar{height:16px;background:var(--pink-soft);border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.06)}
    .bar>i{display:block;height:100%;background:var(--pink);width:0%}

    /* Center logo stays in the middle on all screens */
    .mid-logo{display:grid;place-items:center}
    .mid-logo img{width:64px;height:64px;object-fit:contain}

    /* 24h lock meter (purple) on the right – fill only */
    .lockbox{display:flex;flex-direction:column;gap:6px;justify-self:end;min-width:220px;width:100%}
    .lockline{font-size:12px;color:#333;font-weight:800;text-align:right}
    .lockmeter{position:relative;height:16px;border-radius:999px;background:var(--purple-soft);box-shadow:inset 0 1px 2px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06); overflow:hidden}
    .lockmeter i{position:absolute;left:0;top:0;height:100%;width:0%;background:var(--purple);transition:width .6s}

    /* === Letter screen (no white box) === */
    .letter-screen{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      height:calc(100svh - 120px); /* reserve top bar */
      padding:6px 12px 12px;gap:12px;text-align:center;max-width:1200px;margin:0 auto;
    }
    .card-wrap{display:grid;place-items:center;width:min(900px,96vw);height:min(60vh,64svh);background:transparent}
    .card-wrap img{
      max-width:100%;max-height:100%;object-fit:contain;border-radius:12px;background:transparent;box-shadow:none;
    }

    /* Buttons – never touch/overlap */
    .buttons{display:grid;grid-template-columns:repeat(2,minmax(150px,1fr));gap:14px;width:min(720px,92vw)}
    .btn-audio{
      display:flex;flex-direction:column;align-items:center;gap:6px;border:0;border-radius:20px;padding:16px 18px;font-size:18px;font-weight:900;color:#fff;cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.20);transition:transform .12s, background .12s, opacity .12s
    }
    .btn-audio .num{font-size:26px}
    .btn1{background:#ff5959}.btn2{background:#06b6d4}.btn3{background:#ffd166;color:#111}.btn4{background:#7c5cff}
    .btn-audio:active{transform:scale(.96)}
    .btn-audio[disabled]{opacity:.45;cursor:not-allowed;transform:none}
    .btn1.done{background:#ff7a7a}
    .btn2.done{background:#16c1de}
    .btn3.done{background:#ffe08c;color:#111}
    .btn4.done{background:#9a86ff}
    .btn-audio.done::after{content:" ✓";font-weight:900;font-size:14px;margin-left:4px}

    .btn-finish{margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;box-shadow:0 10px 18px rgba(0,0,0,.18)}
    .btn-finish:active{transform:scale(.96)}

    /* Review arrows (visible from B onward) */
    .arrows{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:8px}
    .arrow{
      width:54px;height:54px;border-radius:999px;border:0;background:#111;color:#fff;font-weight:900;
      box-shadow:0 10px 18px rgba(0,0,0,.25);cursor:pointer;font-size:20px;display:grid;place-items:center
    }
    .arrow:active{transform:scale(.96)}
    .arrow[disabled]{opacity:.4;cursor:not-allowed}

    /* Confetti canvases */
    canvas#confettiFinish{position:fixed;inset:0;pointer-events:none;z-index:50}
    canvas#confettiQuiz{position:fixed;inset:0;pointer-events:none;z-index:200}

    /* QUIZ MODAL (auto) */
    #test{position:fixed;inset:0;z-index:80;display:none}
    #test.active{display:block}
    .t-back{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .t-card{position:relative;z-index:81;background:#fff;border-radius:20px;max-width:900px;margin:6vh auto;padding:16px 16px 18px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
    .t-title{margin:6px 0 2px;font-size:24px}
    .t-prompt{margin:4px 0 12px;color:#444}
    .t-grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .t-item{background:#f7f7fb;border:2px solid transparent;border-radius:14px;padding:8px;display:grid;place-items:center;cursor:pointer;transition:transform .1s, border-color .12s}
    .t-item img{width:100%;height:170px;object-fit:contain}
    .t-item:active{transform:scale(.98)}
    .t-item.correct{border-color:#22c55e}
    .t-item.wrong{border-color:#ef4444}
    .t-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .t-btn{display:none}
    .t-progress{font-weight:800}
    .t-hint{display:none}

    /* === Mobile tuning: equal meters + fit === */
    @media (max-width: 820px){
      .topbar{gap:10px;padding:8px 12px}
      .mid-logo img{width:56px;height:56px}
      .lockbox{min-width:auto}             /* allow equal space with progress */
      .progress,.lockbox{max-width:44vw}   /* visually equal lengths */
      .progress .labels{font-size:12px}
      .lockline{font-size:12px}
      .bar{height:16px}                    /* match lockmeter height */
      .lockmeter{height:16px}
      .letter-screen{height:calc(100svh - 104px);gap:10px;padding:6px 10px}
      .card-wrap{height:min(56vh,60svh)}
      .buttons{gap:12px;width:min(680px,94vw)}
      .btn-audio{padding:14px 16px;font-size:17px}
      .btn-audio .num{font-size:24px}
      .arrow{width:50px;height:50px;font-size:18px}
    }
  </style>
</head>
<body>
  <!-- CSS-only Start fallback anchor -->
  <div id="go"></div>

  <!-- Start / Hello -->
  <div id="hello" class="hello" aria-live="polite">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>スターターアプリへようこそ！</h1>
      <p>このアプリをホーム画面に追加してください。</p>
      <p>次の文字は <strong>24時間後</strong> にアンロックされます！</p>
      <a class="start-link" href="#go" onclick="startAppFull();">スタート</a>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <!-- Left: A–Z meter with only A / Z labels -->
    <div class="progress">
      <div class="labels"><span>A</span><span>Z</span></div>
      <div class="bar"><i id="barFill"></i></div>
    </div>

    <!-- Center: Booha logo -->
    <div class="mid-logo">
      <img src="playful-pink-booha.png" alt="Booha" />
    </div>

    <!-- Right: 24h meter (fill only) -->
    <div class="lockbox">
      <div id="lockStatus" class="lockline">次の文字は 24時間 後にアンロック</div>
      <div class="lockmeter">
        <i id="lockFill"></i>
      </div>
    </div>
  </div>

  <!-- Letter screen -->
  <div class="letter-screen">
    <div class="card-wrap"><img id="letterImg" src="./1.jpg" alt="レター画像" /></div>

    <div class="buttons">
      <button id="btn1" class="btn-audio btn1"><span class="num">①</span><small>リピート</small></button>
      <button id="btn2" class="btn-audio btn2" disabled><span class="num">②</span><small>いっしょに読む</small></button>
      <button id="btn3" class="btn-audio btn3" disabled><span class="num">③</span><small>リピート</small></button>
      <button id="btn4" class="btn-audio btn4" disabled><span class="num">④</span><small>スペシャル！</small></button>
    </div>

    <button id="finishBtn" class="btn-finish">できた！</button>

    <!-- Review arrows (show from B onward) -->
    <div class="arrows" id="arrows" style="display:none">
      <button id="prev" class="arrow" aria-label="まえへ">◀︎</button>
      <button id="next" class="arrow" aria-label="つぎへ">▶︎</button>
    </div>
  </div>

  <!-- Confetti canvases -->
  <canvas id="confettiFinish"></canvas>
  <canvas id="confettiQuiz"></canvas>

  <!-- SFX -->
  <audio id="clickAudio" src="assets/sfx/click.mp3" preload="auto"></audio>
  <audio id="magicAudio" src="assets/sfx/magic.mp3" preload="auto"></audio>

  <!-- QUIZ (auto) -->
  <div id="test">
    <div class="t-back"></div>
    <div class="t-card">
      <h2 class="t-title">テスト</h2>
      <p class="t-prompt">音声を聞いて、正しい<strong>文字</strong>をえらぼう！</p>
      <div id="tGrid" class="t-grid"></div>
      <div class="t-bottom">
        <div id="tProgress" class="t-progress">1 / 1</div>
        <button id="tPlay" class="t-btn">▶︎ 再生</button>
        <button id="tClose" class="t-btn">OK</button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <script>
    /* ---------- Audio ---------- */
    let activeAudio = null, audioCtx = null;
    function stopActive(){ try{ if(activeAudio){ activeAudio.pause(); activeAudio.currentTime = 0; } }catch{} activeAudio=null; }
    function playSound(src, gain=1){
      stopActive();
      try{
        const el = new Audio(src); activeAudio = el;
        if ('AudioContext' in window || 'webkitAudioContext' in window){
          audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
          const node = audioCtx.createMediaElementSource(el);
          const g = audioCtx.createGain(); g.gain.value = gain;
          node.connect(g).connect(audioCtx.destination);
        } else { el.volume = Math.min(1, gain); }
        el.play().catch(()=>{});
      }catch{}
    }
    window.addEventListener('pagehide', stopActive);
    window.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopActive(); });

    /* ---------- Constants & DOM ---------- */
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const MAX_IDX = 25; // A..Z
    const TOTAL_LETTERS = MAX_IDX + 1;

    // Storage keys
    const LS_KEY_DONE = "abc_done_letters";
    const LS_KEY_LAST_TEST = "abc_last_test_m";
    const LS_KEY_UNLOCK_IDX = "abc_unlock_idx";
    const LS_KEY_NEXT_UNLOCK = "abc_next_unlock_ms";

    // DOM refs
    const barFill = document.getElementById("barFill");
    const letterImg = document.getElementById("letterImg");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const finishBtn = document.getElementById("finishBtn");
    const clickAudio = document.getElementById("clickAudio");
    const lockStatus = document.getElementById("lockStatus");
    const lockFill = document.getElementById("lockFill");
    const arrows = document.getElementById("arrows");
    const prev = document.getElementById("prev");
    const next = document.getElementById("next");

    // Quiz
    const test = document.getElementById("test");
    const tGrid = document.getElementById("tGrid");
    const tProgress = document.getElementById("tProgress");

    /* ---------- State ---------- */
    let letterIdx = 0; // 0 = A
    let doneList = loadDoneList();     // ordered
    let doneSet  = new Set(doneList);  // quick lookup
    let lastMilestoneDone = loadNumber(LS_KEY_LAST_TEST, 0);
    let unlockIdx = loadNumber(LS_KEY_UNLOCK_IDX, 0);
    let nextUnlockMs = loadNumber(LS_KEY_NEXT_UNLOCK, 0);

    // ①→②→③→④ (nextStep==5 => finished sequence)
    let nextStep = 1;

    /* ---------- Helpers ---------- */
    function loadDoneList(){
      try{ const raw = JSON.parse(localStorage.getItem(LS_KEY_DONE) || "[]"); return Array.isArray(raw) ? raw : []; }
      catch{ return []; }
    }
    function saveDone(){ try{ localStorage.setItem(LS_KEY_DONE, JSON.stringify(doneList)); }catch{} }
    function loadNumber(key, def){ const n = Number(localStorage.getItem(key) ?? def); return Number.isFinite(n) ? n : def; }
    function saveNumber(key, val){ try{ localStorage.setItem(key, String(val)); }catch{} }

    function getCardBase(i){ return i*4; }
    function firstCardSrc(idx){ return `./${getCardBase(idx)+1}.jpg`; }
    function showCard(n){
      const base = getCardBase(Math.min(letterIdx, MAX_IDX));
      const num = base + n;
      letterImg.src = `./${num}.jpg`;
      letterImg.alt = `レター画像`;
    }

    function updateMeters(){
      barFill.style.width = ((doneSet.size / TOTAL_LETTERS) * 100) + "%";
      // 24h meter fill & text
      if (unlockIdx >= MAX_IDX){
        lockStatus.innerHTML = `<span style="color:#16a34a;font-weight:800">✅ 全ての文字がアンロック済み</span>`;
        lockFill.style.width = '100%';
      } else if (nextUnlockMs > 0){
        const remaining = Math.max(0, nextUnlockMs - Date.now());
        const total = 24*60*60*1000;
        const pct = Math.min(1, 1 - (remaining / total));
        lockFill.style.width = (pct*100).toFixed(1) + '%';
        const s = Math.floor(remaining/1000);
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
        lockStatus.textContent = `次の文字は ${h}時間${m}分${sec}秒 後にアンロック`;
      } else {
        lockFill.style.width = '0%';
        lockStatus.textContent = `次の文字は 24時間 後にアンロック`;
      }
    }

    function refreshUnlocks(){
      if (nextUnlockMs > 0 && Date.now() >= nextUnlockMs && unlockIdx < MAX_IDX){
        unlockIdx = Math.min(unlockIdx + 1, MAX_IDX);
        nextUnlockMs = 0;
        saveNumber(LS_KEY_UNLOCK_IDX, unlockIdx);
        saveNumber(LS_KEY_NEXT_UNLOCK, nextUnlockMs);
      }
      updateMeters();
      updateArrows();
      updateFinishVisibility();
    }
    setInterval(refreshUnlocks, 1000);
    window.addEventListener('focus', refreshUnlocks);

    function clampToUnlocked(i){ return Math.max(0, Math.min(i, unlockIdx)); }

    function firstUnfinishedUnlocked(){
      for (let i=0;i<=unlockIdx;i++){
        if (!doneSet.has(letters[i])) return i;
      }
      return clampToUnlocked(letterIdx);
    }

    function resetSteps(){
      nextStep = 1;
      [btn1,btn2,btn3,btn4].forEach(b=>{ b.classList.remove('done'); });
      setButtonsForStep();
      updateFinishVisibility();
    }
    function setButtonsForStep(){
      btn1.disabled = nextStep !== 1;
      btn2.disabled = nextStep !== 2;
      btn3.disabled = nextStep !== 3;
      btn4.disabled = nextStep !== 4;
    }
    function updateFinishVisibility(){
      const L = letters[letterIdx];
      const alreadyFinished = doneSet.has(L);
      // Show finish button ONLY if this letter isn't finished yet AND steps are complete (appears right after ④)
      finishBtn.style.display = (!alreadyFinished && nextStep === 5) ? 'inline-block' : 'none';
    }

    function updateArrows(){
      // Show arrows once B is unlocked (index >=1)
      arrows.style.display = unlockIdx >= 1 ? 'flex' : 'none';
      prev.disabled = (letterIdx <= 0);
      next.disabled = (letterIdx >= unlockIdx); // cannot jump ahead of 24h lock
    }

    function jumpTo(i){
      const clamped = clampToUnlocked(i);
      if (clamped !== letterIdx){
        letterIdx = clamped;
        resetSteps();
        showCard(1);
        updateMeters();
        updateArrows();
      }
    }

    /* ---------- Start ---------- */
    function startAppFull(){
      startApp();
      refreshUnlocks();
      letterIdx = clampToUnlocked(firstUnfinishedUnlocked());
      resetSteps();
      showCard(1);
      updateMeters();
      updateArrows();
    }
    window.startAppFull = startAppFull;
    if(location.hash === '#go'){ startAppFull(); }

    /* ---------- Buttons (strict order -> show finish after ④) ---------- */
    function playLetterTimes(times){
      const L = letters[letterIdx];
      const name = L.repeat(times);
      playSound(`assets/audio/${name}.m4a`, 1);
    }

    btn1.onclick = ()=>{ if(nextStep!==1) return; showCard(1); playLetterTimes(1); btn1.classList.add('done'); nextStep=2; setButtonsForStep(); updateFinishVisibility(); };
    btn2.onclick = ()=>{ if(nextStep!==2) return; showCard(2); playLetterTimes(2); btn2.classList.add('done'); nextStep=3; setButtonsForStep(); updateFinishVisibility(); };
    btn3.onclick = ()=>{ if(nextStep!==3) return; showCard(3); playLetterTimes(3); btn3.classList.add('done'); nextStep=4; setButtonsForStep(); updateFinishVisibility(); };
    btn4.onclick = ()=>{ if(nextStep!==4) return; showCard(4); playLetterTimes(4); btn4.classList.add('done'); nextStep=5; setButtonsForStep(); updateFinishVisibility(); };

    /* ---------- Finish & quizzes ---------- */
    function maybeOpenTestAfterFinish(){
      const groupsDone = Math.floor(doneSet.size / 5);
      if (doneSet.size > 0 && doneSet.size % 5 === 0 && groupsDone > lastMilestoneDone){
        lastMilestoneDone = groupsDone;
        localStorage.setItem(LS_KEY_LAST_TEST, String(groupsDone));
        openTest();
      }
    }

    function startFinishConfetti(duration=5000){
      const c = document.getElementById("confettiFinish");
      const x = c.getContext("2d");
      function resize(){ c.width = innerWidth; c.height = innerHeight; }
      resize(); window.addEventListener('resize', resize, {once:true});
      const pieces = Array.from({length:360}).map(()=>({
        x: Math.random()*c.width, y: -Math.random()*c.height, r: Math.random()*8+3, vy: Math.random()*2+1.5,
        color: `hsl(${Math.random()*360},100%,55%)`
      }));
      const end = Date.now() + duration;
      (function draw(){
        x.clearRect(0,0,c.width,c.height);
        for(const p of pieces){
          x.beginPath(); x.arc(p.x,p.y,p.r,0,2*Math.PI);
          x.fillStyle = p.color; x.fill();
          p.y += p.vy*2.2; if(p.y>c.height+12){ p.y = -10; p.x = Math.random()*c.width; }
        }
        if(Date.now()<end) requestAnimationFrame(draw); else x.clearRect(0,0,c.width,c.height);
      })();
    }

    function playLetterCueByIndex(idx){ playSound(`assets/audio/${letters[idx]}.m4a`, 1.0); }

    finishBtn.onclick = ()=>{
      try{ clickAudio.currentTime=0; clickAudio.play().catch(()=>{});}catch{}
      const L = letters[letterIdx];
      if(!doneSet.has(L)){
        doneSet.add(L); doneList.push(L); saveDone();
      }

      // Confetti + magic
      playSound('assets/sfx/magic.mp3', 1.5);
      startFinishConfetti(5000);

      // Set next unlock timer only if finishing the highest unlocked
      if (letterIdx === unlockIdx && unlockIdx < MAX_IDX){
        nextUnlockMs = Date.now() + 24*60*60*1000;
        saveNumber(LS_KEY_NEXT_UNLOCK, nextUnlockMs);
      }

      // Quiz every 5 letters
      maybeOpenTestAfterFinish();

      // Z finished -> show finished.jpg and freeze
      if (letterIdx === MAX_IDX){
        letterImg.src = 'finished.jpg';
        [btn1,btn2,btn3,btn4].forEach(b=> b.disabled = true);
        updateMeters(); updateArrows();
        finishBtn.style.display = 'none';
        return;
      }

      // Stay for review; finish button should not re-appear for this letter
      resetSteps();                 // resets steps
      updateFinishVisibility();     // hides finish (already finished)
      showCard(1);
      updateMeters(); updateArrows();
    };

    /* ---------- Review arrows ---------- */
    prev.onclick = ()=> jumpTo(letterIdx - 1);
    next.onclick = ()=> jumpTo(letterIdx + 1);

    /* ---------- Quiz (auto) ---------- */
    function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
    function startQuizConfetti(duration = 8000){
      const c = document.getElementById("confettiQuiz");
      const x = c.getContext("2d");
      function resize(){ c.width = innerWidth; c.height = innerHeight; }
      resize(); window.addEventListener('resize', resize, {once:true});
      const cx = c.width/2, cy = c.height/2;
      let items = [], start = Date.now();
      function emit(n=140){
        for(let i=0;i<n;i++){
          const ang=Math.random()*Math.PI*2, sp=Math.random()*4+2.5, t=Math.random()<.5?'star':'ribbon',
                h1=Math.floor(Math.random()*360), h2=(h1+60+Math.floor(Math.random()*180))%360,
                sat=80+Math.floor(Math.random()*20), l1=55+Math.floor(Math.random()*25), l2=45+Math.floor(Math.random()*25);
          items.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,rot:Math.random()*Math.PI,vr:(Math.random()-.5)*.28,type:t,life:600+Math.random()*1200,c1:`hsl(${h1},${sat}%,${l1}%)`,c2:`hsl(${h2},${sat}%,${l2}%)`});
        }
      }
      emit(180); const iv=setInterval(()=>{ if(Date.now()-start<duration) emit(120); else clearInterval(iv); },600);
      (function draw(){
        const t=Date.now()-start; x.clearRect(0,0,c.width,c.height);
        for(const it of items){
          it.x+=it.vx; it.y+=it.vy; it.vy+=0.045; it.rot+=it.vr; it.life-=16;
          x.save(); x.translate(it.x,it.y); x.rotate(it.rot);
          if(it.type==='star'){ x.fillStyle=it.c1; drawStar(x,0,0,5,8,3.5); x.fill(); }
          else { x.fillStyle=it.c2; x.fillRect(-8,-2,16,4); }
          x.restore();
        }
        items = items.filter(it=> it.life>0 && it.x>-60 && it.x<c.width+60 && it.y<c.height+60 );
        if(t<duration+400) requestAnimationFrame(draw); else x.clearRect(0,0,c.width,c.height);
      })();
    }
    function drawStar(ctx,x,y,spikes,outerR,innerR){
      let rot=Math.PI/2*3, cx=x, cy=y, step=Math.PI/spikes; ctx.beginPath(); ctx.moveTo(cx,cy-outerR);
      for(let i=0;i<spikes;i++){ cx=x+Math.cos(rot)*outerR; cy=y+Math.sin(rot)*outerR; ctx.lineTo(cx,cy); rot+=step; cx=x+Math.cos(rot)*innerR; cy=y+Math.sin(rot)*innerR; ctx.lineTo(cx,cy); rot+=step; }
      ctx.lineTo(x,y-outerR); ctx.closePath();
    }

    function openTest(){
      const recent = doneList.slice(-5).map(L => letters.indexOf(L)).filter(i => i>=0 && i<=MAX_IDX);
      let pool = recent.length >= 4 ? recent : Array.from({length:unlockIdx+1}, (_,i)=>i);
      pool = shuffle(pool).slice(0,4);
      const correctIdx = pool[Math.floor(Math.random()*pool.length)];
      const renderOrder = shuffle([...pool]);
      tGrid.innerHTML = '';
      for(const idx of renderOrder){
        const btn = document.createElement('button');
        btn.type='button'; btn.className='t-item';
        const img = document.createElement('img'); img.src = firstCardSrc(idx); img.alt = 'えらぶレター';
        btn.appendChild(img);
        btn.onclick = ()=>{
          const ok = idx === correctIdx;
          btn.classList.add(ok?'correct':'wrong');
          if(ok){
            playSound('assets/sfx/cheer.mp3', 1.0);
            [...tGrid.querySelectorAll('.t-item')].forEach(b=>b.disabled=true);
            startQuizConfetti(8000);
            setTimeout(closeTest, 1400);
          }else{
            setTimeout(()=> btn.classList.remove('wrong'), 380);
          }
        };
        tGrid.appendChild(btn);
      }
      playLetterCueByIndex(correctIdx);
      tProgress.textContent = '1 / 1';
      test.classList.add('active');
      test.addEventListener('click', (e)=>{ if(e.target.classList.contains('t-back')) closeTest(); }, {once:true});
    }
    function closeTest(){ test.classList.remove('active'); stopActive(); }
  </script>
</body>
</html>
