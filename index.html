<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブーハABC</title>

  <!-- EARLY: minimal fallback so Start always works even if later JS fails -->
  <script>
    function startApp(){
      const hello = document.getElementById('hello');
      if (hello) hello.style.display = 'none';
      const img = document.getElementById('cardImg');
      if (img) { img.src = './1.jpg'; img.alt = 'カード1'; }
    }
    window.startApp = startApp; // keep global for inline onclick
  </script>

  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/cover no-repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.22);z-index:-1}

    /* Hello / Start */
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.75);z-index:10}
    .hello-card{position:relative;z-index:11;background:#fff;border-radius:20px;padding:24px;max-width:420px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:140px;height:auto;margin:0 auto;display:block}
    .hello-card h1{margin:12px 0 6px;font-size:27px;line-height:1.05}
    .hello-card p{margin:4px 0;font-size:13px;color:#444}
    .hello-card button{margin-top:16px;padding:12px 20px;font-size:18px;font-weight:900;background:#ff4da6;color:#fff;border:0;border-radius:14px;cursor:pointer;box-shadow:0 10px 18px rgba(255,77,166,.28)}
    .hello-card button:active{transform:scale(.98)}

    /* Top bar */
    .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 16px}
    .left{display:flex;align-items:center;gap:10px}
    .progress{width:150px}
    .bar{height:10px;background:#ffd1e6;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
    .bar>i{display:block;height:100%;background:#ff4da6;width:0%}
    .actions{display:flex;gap:8px}
    .chip{border:0;border-radius:14px;padding:8px 12px;font-weight:800;cursor:pointer;background:#111;color:#fff}
    .chip:active{transform:scale(.98)}

    /* Letter view */
    .letter-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 80px);padding:16px;gap:16px;text-align:center}
    .card-wrap{display:grid;place-items:center;width:min(900px,96vw);min-height:40vh}
    .card-wrap img{max-width:100%;max-height:70vh;object-fit:contain;border-radius:12px;box-shadow:none}

    .buttons{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:12px;width:min(680px,92vw)}
    .btn-audio{display:flex;flex-direction:column;align-items:center;gap:6px;border:0;border-radius:18px;padding:16px 18px;font-size:18px;font-weight:900;color:#fff;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.20)}
    .btn-audio .num{font-size:26px}
    .btn1{background:#ff5959}.btn2{background:#06b6d4}.btn3{background:#ffd166;color:#111}.btn4{background:#7c5cff}
    .btn-audio:active{transform:scale(.92)}
    .btn-finish{margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;box-shadow:0 10px 18px rgba(0,0,0,.18)}
    .btn-finish:active{transform:scale(.92)}

    /* Dev row */
    .dev{position:fixed;left:0;right:0;bottom:8px;display:flex;gap:8px;justify-content:center;z-index:60}
    .tbtn{background:#111;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-size:12px;opacity:.9;cursor:pointer}
    .tbtn:active{transform:scale(.98)}

    /* Confetti canvas */
    canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:50}

    /* Quiz modal */
    #quiz{position:fixed;inset:0;z-index:80;display:none}
    #quiz.active{display:block}
    .q-back{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .q-card{position:relative;z-index:81;background:#fff;border-radius:20px;max-width:900px;margin:6vh auto;padding:16px 16px 18px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
    .q-title{margin:6px 0 2px;font-size:24px}
    .q-prompt{margin:4px 0 12px;color:#444}
    .q-ctrl{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .q-grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .q-btn{background:#f7f7fb;border:2px solid transparent;border-radius:14px;padding:8px;display:grid;place-items:center;cursor:pointer;transition:transform .1s, border-color .12s}
    .q-btn img{width:100%;height:170px;object-fit:contain}
    .q-btn:active{transform:scale(.98)}
    .q-btn.correct{border-color:#22c55e}
    .q-btn.wrong{border-color:#ef4444}
    .q-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .q-chip{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer}
    .q-ok{background:#28a745}
    .q-progress{font-weight:800}
    @media (max-width:820px){.q-grid{grid-template-columns:repeat(2,1fr)}.q-btn img{height:140px}}
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <!-- Hello -->
  <div id="hello" class="hello" aria-live="polite">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>こんにちは！</h1>
      <p>スタートすると、A〜Hのカードとクイズで練習できます。</p>
      <p>音声はタップで再生されます。</p>
      <button id="startBtn" type="button" onclick="startApp()">スタート</button>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="left">
      <div class="progress"><div class="bar"><i id="barFill" style="width:0%"></i></div></div>
      <div id="where" aria-live="polite">A / 4枚</div>
    </div>
    <div class="actions">
      <button id="quizBtn" class="chip">クイズ</button>
    </div>
  </div>

  <!-- Letter screen -->
  <div class="letter-screen">
    <div class="card-wrap"><img id="cardImg" src="./1.jpg" alt="カード1" /></div>

    <div class="buttons">
      <button id="btn1" class="btn-audio btn1"><span class="num">①</span><small>リピート</small></button>
      <button id="btn2" class="btn-audio btn2"><span class="num">②</span><small>いっしょに読む</small></button>
      <button id="btn3" class="btn-audio btn3"><span class="num">③</span><small>リピート</small></button>
      <button id="btn4" class="btn-audio btn4"><span class="num">④</span><small>スペシャル！</small></button>
    </div>

    <button id="finishBtn" class="btn-finish">できた！</button>
  </div>

  <!-- Dev helpers (optional) -->
  <div class="dev">
    <button id="prev" class="tbtn">← letter</button>
    <button id="next" class="tbtn">letter →</button>
    <button id="reset" class="tbtn">reset</button>
    <button id="demoB" class="tbtn">Bクイズ(1/5/9/13)</button>
  </div>

  <canvas id="confetti"></canvas>

  <!-- SFX -->
  <audio id="clickAudio" src="assets/sfx/click.mp3" preload="auto"></audio>
  <audio id="magicAudio" src="assets/sfx/magic.mp3" preload="auto"></audio>

  <!-- Quiz modal -->
  <div id="quiz" style="display:none">
    <div class="q-back"></div>
    <div class="q-card">
      <h2 class="q-title" id="qTitle">クイック・クイズ</h2>
      <p class="q-prompt" id="qPrompt">音声を聞いて、正しいカードをえらぼう！</p>
      <div class="q-ctrl">
        <button id="qPlay" class="q-chip">▶︎ 再生</button>
        <span id="qHint" style="color:#555;font-size:14px"></span>
      </div>
      <div id="qGrid" class="q-grid"></div>
      <div class="q-bottom">
        <div id="qProgress" class="q-progress">1 / 3</div>
        <button id="qClose" class="q-chip q-ok" style="display:none">OK</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Safety net ---------- */
    (function trap(){
      const og = console.error.bind(console);
      window.addEventListener('error', e => { try{ og('JS error:', e.message); }catch{} }, {capture:true});
      window.addEventListener('unhandledrejection', e => { try{ og('Promise rejection:', e.reason); }catch{} });
    })();

    /* ---------- Constants & DOM ---------- */
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const MAX_IDX = 7; // A..H mapped -> 1..32.jpg
    const hello = document.getElementById("hello");
    const barFill = document.getElementById("barFill");
    const where = document.getElementById("where");
    const cardImg = document.getElementById("cardImg");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const finishBtn = document.getElementById("finishBtn");
    const clickAudio = document.getElementById("clickAudio");
    const magicAudio = document.getElementById("magicAudio");
    const quizBtn = document.getElementById("quizBtn");
    const prev = document.getElementById("prev");
    const next = document.getElementById("next");
    const reset = document.getElementById("reset");
    const demoB = document.getElementById("demoB");

    /* ---------- App state ---------- */
    let letterIdx = 0; // 0=A
    let step = 0;      // which play button next (0..4)
    let confettiRunning = false;

    function getCardBase(i){ return i*4; }
    function showCard(n){
      const base = getCardBase(Math.min(letterIdx, MAX_IDX));
      const num = base + n; // 1..4
      cardImg.src = `./${num}.jpg`;
      cardImg.alt = `カード${n}`;
    }
    function updateTop(){
      barFill.style.width = (((letterIdx+1)/26)*100)+"%";
      where.textContent = `${letters[letterIdx]} / 4枚`;
    }

    function startApp(){ // upgrades fallback
      hello.style.display = "none";
      letterIdx = Math.max(0, Math.min(letterIdx, MAX_IDX));
      step = 0;
      showCard(1);
      updateTop();
    }
    window.startApp = startApp; // keep global for inline onclick
    document.getElementById('startBtn')?.addEventListener('click', startApp);
    window.addEventListener('load', ()=>{ // if overlay somehow still up, rebind
      if(hello.style.display !== 'none'){
        document.getElementById('startBtn')?.addEventListener('click', startApp);
      }
    });

    /* ---------- Audio helpers ---------- */
    function playClick(){ try{ clickAudio.currentTime=0; clickAudio.play().catch(()=>{});}catch{} }
    function playLetterTimes(times){
      const L = letters[letterIdx];
      const name = L.repeat(times); // "A","AA","AAA","AAAA"
      const src = `assets/audio/${name}.m4a`;
      const a = new Audio(src);
      a.play().catch(()=>{});
    }

    /* ---------- Buttons 1..4 ---------- */
    btn1.onclick = ()=>{ showCard(1); playLetterTimes(1); step = 1; };
    btn2.onclick = ()=>{ showCard(2); playLetterTimes(2); step = 2; };
    btn3.onclick = ()=>{ showCard(3); playLetterTimes(3); step = 3; };
    btn4.onclick = ()=>{ showCard(4); playLetterTimes(4); step = 4; finishBtn.style.display='inline-block'; };

    /* ---------- Finish letter ---------- */
    finishBtn.onclick = ()=>{
      playClick();
      try{ magicAudio.currentTime=0; magicAudio.play().catch(()=>{});}catch{}
      startConfetti(1500);
      finishBtn.style.display='none';
      step = 0;
      // auto-advance to next letter (loops within A–H)
      letterIdx = (letterIdx+1)%(MAX_IDX+1);
      showCard(1);
      updateTop();
      // prompt: offer quiz
      openQuiz(); // fun: pop a quiz right after finish
    };

    /* ---------- Dev nav ---------- */
    prev.onclick = ()=>{ letterIdx = Math.max(0, letterIdx-1); step=0; finishBtn.style.display='none'; showCard(1); updateTop(); };
    next.onclick = ()=>{ letterIdx = Math.min(MAX_IDX, letterIdx+1); step=0; finishBtn.style.display='none'; showCard(1); updateTop(); };
    reset.onclick = ()=>{ location.reload(); };

    /* ---------- Confetti ---------- */
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    function startConfetti(duration){
      if(confettiRunning) return;
      confettiRunning = true;
      resize();
      const pieces = Array.from({length:220}).map(()=>({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height - canvas.height,
        r: Math.random()*8+3,
        d: Math.random()*1+0.5,
        c: `hsl(${Math.random()*360},100%,50%)`
      }));
      const end = Date.now() + duration;
      (function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const p of pieces){ ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,2*Math.PI); ctx.fillStyle=p.c; ctx.fill(); p.y+=p.d*4; if(p.y>canvas.height){ p.y=-10; p.x=Math.random()*canvas.width; } }
        if(Date.now()<end) requestAnimationFrame(draw); else { confettiRunning=false; ctx.clearRect(0,0,canvas.width,canvas.height); }
      })();
    }
    window.onresize = resize;
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    resize();

    /* ---------- QUIZ: 4-choice sound match (3 rounds) ---------- */
    const quiz = document.getElementById("quiz");
    const qGrid = document.getElementById("qGrid");
    const qPlay = document.getElementById("qPlay");
    const qClose = document.getElementById("qClose");
    const qProgress = document.getElementById("qProgress");
    const qHint = document.getElementById("qHint");

    let round = 0;
    const TOTAL_ROUNDS = 3;

    function firstCardSrc(idx){ return `./${getCardBase(idx)+1}.jpg`; }

    function pick4Letters(){
      const pool = Array.from({length:MAX_IDX+1}, (_,i)=>i);
      pool.sort(()=>Math.random()-0.5);
      return pool.slice(0,4);
    }

    function playLetterCue(idx){
      const L = letters[idx];
      const a = new Audio(`assets/audio/${L}.m4a`);
      a.play().catch(()=>{});
      qHint.textContent = `（${L} の音）`;
    }

    function openQuiz(){
      round = 0;
      qClose.style.display = 'none';
      quiz.classList.add('active');
      nextRound();
    }

    function nextRound(){
      round++;
      if(round > TOTAL_ROUNDS){
        startConfetti(1200);
        qProgress.textContent = `${TOTAL_ROUNDS} / ${TOTAL_ROUNDS}`;
        qHint.textContent = 'よくできました！';
        qClose.style.display = 'inline-block';
        return;
      }

      qProgress.textContent = `${round} / ${TOTAL_ROUNDS}`;
      qGrid.innerHTML = '';

      const choices = pick4Letters();               // 4 letter indices
      const correctIdx = choices[Math.floor(Math.random()*choices.length)];

      // render
      for(const idx of choices){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'q-btn';
        const img = document.createElement('img');
        img.src = firstCardSrc(idx);
        img.alt = 'えらぶカード';
        btn.appendChild(img);
        btn.onclick = ()=>{
          const ok = idx === correctIdx;
          btn.classList.add(ok?'correct':'wrong');
          if(ok){
            try{ magicAudio.currentTime=0; magicAudio.play().catch(()=>{});}catch{}
            // lock and advance
            [...qGrid.querySelectorAll('.q-btn')].forEach(b=>b.disabled=true);
            setTimeout(nextRound, 500);
          }else{
            setTimeout(()=>btn.classList.remove('wrong'), 380);
          }
        };
        qGrid.appendChild(btn);
      }

      // play cue
      qPlay.onclick = ()=> playLetterCue(correctIdx);
      // auto play once
      setTimeout(()=> qPlay.click(), 120);
    }

    function closeQuiz(){ quiz.classList.remove('active'); }
    quiz.addEventListener('click', e=>{ if(e.target.classList.contains('q-back')) closeQuiz(); });
    qClose.addEventListener('click', closeQuiz);
    quizBtn.addEventListener('click', openQuiz);

    /* ---------- DEMO: fixed B quiz (images 1,5,9,13; correct 5.jpg) ---------- */
    demoB.addEventListener('click', ()=>{
      // reuse modal but set fixed choices and fixed cue
      round = 1; // single round feel
      qProgress.textContent = `1 / 1`;
      qHint.textContent = '（B の音）';
      qClose.style.display = 'none';
      qGrid.innerHTML = '';
      const imgs = [1,5,9,13].map(n=>`./${n}.jpg`);
      const correctSrc = './5.jpg';
      imgs.sort(()=>Math.random()-0.5);
      imgs.forEach(src=>{
        const b = document.createElement('button');
        b.type='button'; b.className='q-btn';
        const img = document.createElement('img'); img.src = src; img.alt='えらぶカード';
        b.appendChild(img);
        b.onclick = ()=>{
          const ok = (src===correctSrc);
          b.classList.add(ok?'correct':'wrong');
          if(ok){
            try{ magicAudio.currentTime=0; magicAudio.play().catch(()=>{});}catch{}
            [...qGrid.querySelectorAll('.q-btn')].forEach(x=>x.disabled=true);
            qClose.style.display='inline-block';
          }else{
            setTimeout(()=> b.classList.remove('wrong'), 380);
          }
        };
        qGrid.appendChild(b);
      });
      qPlay.onclick = ()=> new Audio('assets/audio/B.m4a').play().catch(()=>{});
      quiz.classList.add('active');
      setTimeout(()=> qPlay.click(), 120);
    });

    /* ---------- Auto-hide overlay if previously started ---------- */
    // (Optional: if you want to remember, uncomment below)
    // if(localStorage.getItem('abc_started')) { startApp(); }
    // document.getElementById('startBtn')?.addEventListener('click', ()=> localStorage.setItem('abc_started','1'));
  </script>
</body>
</html>
