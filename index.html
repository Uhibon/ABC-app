<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„Éñ„Éº„ÉèABC ‚Äì Starter</title>
  <link rel="icon" type="image/png" href="playful-pink-booha.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ff5bb0">

  <style>
    :root{
      --ink:#1f2328; --muted:#6b7280;
      --pink:#ff5bb0;   /* A‚ÄìZ meter */
      --purple:#8b5cf6; /* 24h clock */
      --ok:#22c55e; --bad:#ef4444; --ring:rgba(0,0,0,.08);
      --card:#ffffffd9; --bg:#f7f8fb;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-rounded,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      color:var(--ink);
      background:url('Booha card.jpg') center/cover fixed no-repeat;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    header{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px;
      margin:8px 0 12px;
    }
    .chip{
      background:var(--card); border:1px solid var(--ring); border-radius:999px;
      padding:8px 12px; display:flex; align-items:center; gap:10px;
      box-shadow:0 4px 10px rgba(0,0,0,.06);
    }
    /* A‚ÄìZ meter (left) */
    .meterAZ{gap:8px}
    .rail{position:relative; width:140px; height:8px; background:#ffe1ef; border-radius:999px; overflow:hidden}
    .fill{position:absolute; inset:0 0 0 auto; background:var(--pink)}
    .az-label{font-weight:700; font-variant-numeric:tabular-nums}
    .letterNow{font-weight:700}

    /* 24h clock (right) */
    .clock{justify-content:flex-end}
    .clock .rail{width:140px; background:#ebe7ff}
    .clock .fill{background:var(--purple)}
    .count{font-weight:800; letter-spacing:.3px}

    /* Start screen */
    .hero{
      display:grid; place-items:center; min-height:30vh; margin-top:12vh;
    }
    .card{
      width:min(680px,100%); background:var(--card); border:1px solid var(--ring);
      border-radius:24px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.08);
      text-align:center;
    }
    .title{font-size:28px; margin:0 0 4px}
    .sub{color:var(--muted); margin:6px 0 16px}
    .startBtn{
      width:100%; max-width:420px; padding:14px 16px; font-size:18px; font-weight:800;
      border-radius:16px; border:0; background:var(--pink); color:white; cursor:pointer;
    }
    .ghost{width:64px; height:64px; object-fit:contain}

    /* Player area */
    .player{display:grid; gap:12px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .nav{
      display:flex; gap:8px; visibility:hidden; /* becomes visible once B unlocks */
    }
    .nav button{
      padding:8px 12px; border-radius:12px; border:1px solid var(--ring); background:#fff; cursor:pointer;
    }
    .nav button[disabled]{opacity:.45; cursor:not-allowed}

    .stage{display:grid; gap:14px}
    .letterBadge{
      font-size:24px; font-weight:900; background:#fff; border:1px solid var(--ring);
      padding:8px 14px; border-radius:14px; display:inline-flex; align-items:center; gap:8px;
    }

    .grid4{
      display:grid; grid-template-columns:repeat(2,1fr); gap:12px;
    }
    .cell{
      background:#fff; border:2px solid #eee; border-radius:18px; overflow:hidden;
      display:grid; place-items:center; aspect-ratio:1; position:relative;
    }
    .cell img{width:100%; height:100%; object-fit:cover}
    .step{
      position:absolute; top:8px; left:8px; font-weight:900; background:#000; color:#fff;
      width:30px; height:30px; display:grid; place-items:center; border-radius:999px; opacity:.85;
    }
    .cell button.tap{
      position:absolute; inset:0; width:100%; height:100%; background:transparent; border:0; cursor:pointer;
    }
    .cell.done{outline:3px solid var(--ok)}
    .cell.locked{filter:grayscale(1); opacity:.65}

    .finish{
      display:none; margin-top:2px; padding:14px 16px; font-size:18px; font-weight:900;
      border-radius:16px; border:0; background:linear-gradient(0deg,#ffd1ea,#fff);
      border:2px solid var(--pink); color:#111; cursor:pointer;
    }

    .hint{color:var(--muted); font-size:13px; text-align:center}
    @media (max-width:760px){
      .grid4{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top meters -->
    <header>
      <!-- A‚ÄìZ meter -->
      <div class="chip meterAZ">
        <span class="az-label">A</span>
        <div class="rail" aria-label="A-Z progress">
          <div id="azFill" class="fill" style="width:0%"></div>
        </div>
        <span class="az-label">Z</span>
        <span class="letterNow" id="letterNow">A</span>
      </div>

      <img class="ghost" src="playful-pink-booha.png" alt="Booha" />

      <!-- 24h clock -->
      <div class="chip clock">
        <span style="font-weight:700">Next unlock</span>
        <div class="rail" aria-label="24h countdown">
          <div id="tFill" class="fill" style="width:0%"></div>
        </div>
        <span class="count" id="count">--:--:--</span>
      </div>
    </header>

    <!-- Start screen -->
    <section id="start" class="hero">
      <div class="card">
        <h1 class="title">Let‚Äôs start ABC!</h1>
        <p class="sub">Tap ‚ë† ‚Üí ‚ë° ‚Üí ‚ë¢ ‚Üí ‚ë£ in order. Then press <b>„Åß„Åç„ÅüÔºÅ/ FINISHED!</b><br>One new letter unlocks every 24 hours.</p>
        <button class="startBtn" id="go">Start / „Çπ„Çø„Éº„Éà</button>
      </div>
    </section>

    <!-- Player -->
    <section id="app" class="player" style="display:none">
      <div class="topbar">
        <div class="letterBadge">Letter: <span id="badge">A</span></div>
        <div class="nav" id="nav">
          <button id="prev">‚Üê Prev</button>
          <button id="next">Next ‚Üí</button>
        </div>
      </div>

      <div class="stage">
        <div class="grid4" id="grid">
          <!-- 4 cells auto-filled by JS -->
        </div>
        <button id="finish" class="finish">üåü‚ú® „Åß„Åç„Åü„Å≠ÔºÅ / FINISHED! ‚ú®üåü</button>
        <p class="hint">Audio won‚Äôt overlap. Buttons unlock in order ‚ë†‚Üí‚ë°‚Üí‚ë¢‚Üí‚ë£.</p>
      </div>
    </section>
  </div>

  <audio id="snd" preload="auto"></audio>
  <audio id="sfxClick" src="sfx/click.mp3" preload="auto"></audio>
  <audio id="sfxCheer" src="sfx/cheer.mp3" preload="auto"></audio>

  <script>
    // ------------------ Config ------------------
    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    // For this base build, only A and B have assets. The code scales to all 26.
    const LAST_AVAILABLE_INDEX = 1; // 0:A, 1:B

    const ASSET = (letter, step) => ({
      img: `img/${letter}_${step}.jpg`,
      audio: `audio/${letter}${step}.m4a`
    });

    // ------------------ State (localStorage) ------------------
    const LS = {
      idx:  "abc_currentIndex",
      fin:  "abc_finished",
      next: "abc_nextUnlockMs"
    };

    const now = () => Date.now();
    const H24 = 24*60*60*1000;

    function loadState(){
      const idx = +(localStorage.getItem(LS.idx) ?? 0);
      const finished = JSON.parse(localStorage.getItem(LS.fin) ?? "[]"); // array of indices done
      const nextUnlockMs = +(localStorage.getItem(LS.next) ?? 0);
      return {idx, finished, nextUnlockMs};
    }
    function saveState(s){
      localStorage.setItem(LS.idx, String(s.idx));
      localStorage.setItem(LS.fin, JSON.stringify(s.finished));
      localStorage.setItem(LS.next, String(s.nextUnlockMs||0));
    }

    // ------------------ DOM refs ------------------
    const qs = s => document.querySelector(s);
    const start = qs("#start");
    const app   = qs("#app");
    const goBtn = qs("#go");
    const grid  = qs("#grid");
    const badge = qs("#badge");
    const letterNow = qs("#letterNow");
    const azFill = qs("#azFill");
    const tFill  = qs("#tFill");
    const count  = qs("#count");
    const nav    = qs("#nav");
    const prev   = qs("#prev");
    const next   = qs("#next");
    const finish = qs("#finish");

    const snd = qs("#snd");
    const sfxClick = qs("#sfxClick");
    const sfxCheer = qs("#sfxCheer");

    // Tap order state per session/letter
    let expectedTap = 1;
    let current = loadState();

    // Ensure we don‚Äôt strand the user if the 24h already passed while app was closed
    function reconcileUnlock(){
      if(current.finished.includes(current.idx) && current.idx < LAST_AVAILABLE_INDEX){
        if(now() >= current.nextUnlockMs){
          current.idx = Math.min(current.idx+1, LAST_AVAILABLE_INDEX);
          current.nextUnlockMs = 0;
          saveState(current);
        }
      }
    }

    // ------------------ UI Build ------------------
    function buildCells(){
      grid.innerHTML = "";
      const L = LETTERS[current.idx];
      for(let i=1;i<=4;i++){
        const {img} = ASSET(L,i);
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.innerHTML = `
          <span class="step">${i}</span>
          <img alt="${L}-${i}" src="${img}">
          <button class="tap" data-step="${i}" aria-label="${L} step ${i}"></button>
        `;
        grid.appendChild(cell);
      }
      decorateCells();
    }

    function decorateCells(){
      // lock visuals for out-of-order steps
      for(const cell of grid.children){
        const step = +cell.querySelector(".tap").dataset.step;
        cell.classList.toggle("locked", step>expectedTap);
        cell.classList.toggle("done", step<expectedTap);
      }
      // Finished button visible only when all 4 tapped and this letter not already finished
      const isFinished = current.finished.includes(current.idx);
      finish.style.display = (expectedTap===5 && !isFinished) ? "block" : "none";
    }

    function setMeters(){
      const pos = current.idx;                       // 0..25
      const percent = (pos/25)*100;                  // A..Z rail fill
      azFill.style.width = `${percent}%`;
      const L = LETTERS[pos];
      letterNow.textContent = L;
      badge.textContent = L;

      // 24h clock rail & text
      const hasNext = (pos < LAST_AVAILABLE_INDEX);
      const gateActive = current.finished.includes(pos) && hasNext && current.nextUnlockMs>now();
      if(gateActive){
        const total = current.nextUnlockMs - (current.nextUnlockMs - H24);
        const remain = current.nextUnlockMs - now();
        const done = H24 - remain;
        const pct = Math.max(0, Math.min(100, (done/H24)*100));
        tFill.style.width = `${pct}%`;
        count.textContent = fmtHMS(remain);
      }else{
        const remain = Math.max(0, current.nextUnlockMs - now());
        tFill.style.width = remain>0 ? "99%" : "0%";
        count.textContent = remain>0 ? fmtHMS(remain) : "00:00:00";
      }

      // Arrows visible only once B (index 1) is unlocked at least once
      nav.style.visibility = (maxUnlockedIndex()>=1) ? "visible" : "hidden";

      // Clamp arrow enablement
      prev.disabled = (current.idx<=0);
      next.disabled = (current.idx>=maxUnlockedIndex());
    }

    function maxUnlockedIndex(){
      // If we finished a letter and the gate expired, next becomes unlocked.
      const base = current.finished.slice().sort((a,b)=>b-a)[0] ?? 0;
      if(current.finished.includes(base) && (now()>=current.nextUnlockMs)) {
        return Math.min(base+1, LAST_AVAILABLE_INDEX);
      }
      // Else, highest finished or current (whichever is greater) but no peek ahead
      return Math.max(current.idx, current.finished.slice(-1)[0] ?? 0);
    }

    function fmtHMS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    function stopAudio(){
      try{ snd.pause(); snd.currentTime = 0; }catch{}
    }

    // ------------------ Events ------------------
    goBtn.addEventListener("click", ()=>{
      sfxClick.play().catch(()=>{});
      start.style.display = "none";
      app.style.display = "grid";
      reconcileUnlock();
      expectedTap = current.finished.includes(current.idx) ? 5 : 1;
      buildCells(); setMeters();
    });

    grid.addEventListener("click", (e)=>{
      const btn = e.target.closest(".tap");
      if(!btn) return;
      const step = +btn.dataset.step;

      // Enforce order
      if(step !== expectedTap) return;

      const L = LETTERS[current.idx];
      const {audio} = ASSET(L, step);
      stopAudio();
      snd.src = audio;
      snd.play().catch(()=>{});

      sfxClick.currentTime = 0; sfxClick.play().catch(()=>{});

      expectedTap++;
      decorateCells();
    });

    finish.addEventListener("click", ()=>{
      // Mark finished for this letter
      if(!current.finished.includes(current.idx)) current.finished.push(current.idx);
      // Start 24h gate only if there is a next letter available
      if(current.idx < LAST_AVAILABLE_INDEX){
        current.nextUnlockMs = now() + H24;
      }else{
        current.nextUnlockMs = 0; // nothing more to unlock in this demo
      }
      saveState(current);
      finish.style.display = "none";
      sfxCheer.currentTime = 0; sfxCheer.play().catch(()=>{});
      setMeters();
    });

    prev.addEventListener("click", ()=>{
      if(current.idx<=0) return;
      stopAudio();
      current.idx--;
      expectedTap = current.finished.includes(current.idx) ? 5 : 1;
      saveState(current);
      buildCells(); setMeters();
    });

    next.addEventListener("click", ()=>{
      // Can never go past max unlocked
      const maxU = maxUnlockedIndex();
      if(current.idx>=maxU) return;
      stopAudio();
      current.idx++;
      expectedTap = current.finished.includes(current.idx) ? 5 : 1;
      saveState(current);
      buildCells(); setMeters();
    });

    // Live tick: update countdown + arrow enable
    setInterval(()=>{
      reconcileUnlock();
      setMeters();
    }, 1000);

    // Boot: show start screen first
    (function boot(){
      // Minimal SW registration
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      }
    })();
  </script>
</body>
</html>
