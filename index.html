<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブーハABC</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

    /* Background stretched */
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/cover no-repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.22);z-index:-1}

    /* Hello / Start */
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.7);z-index:10}
    .hello-card{
      position:relative; z-index:11;
      background:#fff;border-radius:20px;padding:24px;text-align:center;max-width:420px;
      box-shadow:0 8px 20px rgba(0,0,0,.2);overflow:visible
    }
    .hello-card img{display:block;width:140px;height:auto;object-fit:contain;margin:0 auto}
    .hello-card h1{margin:12px 0 6px;font-size:27px;line-height:1.05}
    .hello-card p{margin:4px 0;font-size:13px;color:#444}
    .hello-card button{
      margin-top:16px;padding:12px 20px;font-size:18px;font-weight:bold;
      background:#ff4da6;color:#fff;border:0;border-radius:14px;cursor:pointer;
      box-shadow:0 10px 18px rgba(255,77,166,.28)
    }
    .hello-card button:active{transform:scale(.98)}

    /* Top bar (cute) */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    .progress{flex:1;margin-right:12px}
    .bar{height:12px;background:#ffd1e6;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
    .bar>i{display:block;height:100%;background:#ff4da6;width:0%;transition:width .35s ease}
    .countdown{font-size:14px;color:#333}

    /* Letter screen with card */
    .letter-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 80px);padding:16px;text-align:center;gap:16px}

    /* Only the full card image — no white background */
    .card-wrap{
      display:grid;place-items:center;
      width:min(900px, 96vw);
      min-height:40vh;
      background:transparent;border:0;padding:0;box-shadow:none;
    }
    .card-wrap img{
      max-width:100%;
      max-height:70vh;
      width:auto;height:auto;
      object-fit:contain;
      border-radius:12px;
    }

    /* Play buttons */
    .buttons{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:12px;width:min(680px, 92vw)}
    .btn-audio{
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      border:0;border-radius:18px;padding:16px 18px;
      font-size:18px;font-weight:900;color:#fff;cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.20);
      transition: transform 0.15s ease, background-color .12s ease;
    }
    .btn-audio:active{transform:scale(0.92)}
    .btn-audio.pressed{background:#7c5cff !important; color:#fff}
    .btn-audio .num{font-size:26px;line-height:1}
    .btn-audio small{font-weight:700;font-size:12px;opacity:.95}
    .btn1{background:#ff5959}
    .btn2{background:#06b6d4}
    .btn3{background:#ffd166;color:#111}
    .btn4{background:#7c5cff}
    .btn-audio[disabled]{opacity:.65;cursor:default}

    .btn-finish{
      margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;
      font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
    }
    .btn-finish:active{transform:scale(0.92)}
    .btn-finish.pressed{background:#7c5cff}

    canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:50}

    /* ===== TEMP TEST CONTROLS (bottom) ===== */
    .test-controls{
      position:fixed;left:0;right:0;bottom:8px;
      display:flex;gap:8px;justify-content:center;z-index:60;
    }
    .test-controls .tbtn{
      background:#111;color:#fff;border:0;border-radius:10px;
      padding:8px 12px;font-size:12px;opacity:.9;cursor:pointer;
    }
    .test-controls .tbtn:active{transform:scale(.98)}

    /* === MINI-GAME (modal) === */
    #quizModal{position:fixed;inset:0;z-index:80;display:none}
    #quizModal.active{display:block}
    #quizModal .quiz-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    #quizModal .quiz-card{
      position:relative; z-index:81; max-width:820px; margin:6vh auto; padding:16px;
      background:#fff; border-radius:20px; box-shadow:0 18px 40px rgba(0,0,0,.25)
    }
    .quiz-card h2{margin:6px 0 2px; font-size:24px}
    .quiz-prompt{margin:4px 0 12px; color:#444}
    .quiz-choices{display:grid; gap:12px; grid-template-columns:repeat(3,1fr)}
    .quiz-choice{
      display:grid; place-items:center; background:#f7f7fb; border:2px solid transparent;
      border-radius:14px; padding:8px; cursor:pointer; transition:transform .12s ease, border-color .12s;
    }
    .quiz-choice img{width:100%; height:180px; object-fit:contain}
    .quiz-choice:active{transform:scale(.98)}
    .quiz-choice.correct{border-color:#22c55e}
    .quiz-choice.wrong{border-color:#ef4444}
    .quiz-bottom{display:flex; align-items:center; justify-content:space-between; margin-top:12px}
    .quiz-progress{font-weight:700}
    .quiz-close{
      background:#28a745; color:#fff; border:0; border-radius:12px; padding:10px 16px; font-weight:900; cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.15);
    }
    @media (max-width:720px){
      .quiz-choices{grid-template-columns:1fr 1fr}
      .quiz-choice img{height:140px}
    }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <!-- Hello -->
  <div id="hello" class="hello" aria-live="polite">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>こんにちは！</h1>
      <p>スタートすると、毎日１つの文字が解放されます。</p>
      <p>進捗を守るため、同じ端末をご使用ください。</p>
      <button id="startBtn" type="button">スタート</button>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="progress"><div class="bar"><i id="barFill"></i></div></div>
    <div id="countdown" class="countdown">—:—:—</div>
  </div>

  <!-- Letter of the day -->
  <div class="letter-screen">
    <div class="card-wrap">
      <img id="cardImg" src="./1.jpg" alt="カード1" />
    </div>

    <div class="buttons">
      <button id="btn1" class="btn-audio btn1">
        <span class="num">①</span><small>リピート</small>
      </button>
      <button id="btn2" class="btn-audio btn2">
        <span class="num">②</span><small>いっしょに読む</small>
      </button>
      <button id="btn3" class="btn-audio btn3">
        <span class="num">③</span><small>リピート</small>
      </button>
      <button id="btn4" class="btn-audio btn4">
        <span class="num">④</span><small>スペシャル！</small>
      </button>
    </div>

    <button id="finishBtn" class="btn-finish">できた！</button>
  </div>

  <!-- TEMP test controls -->
  <div class="test-controls" aria-label="temporary test controls">
    <button id="devBack"  class="tbtn">← back</button>
    <button id="devNext"  class="tbtn">next →</button>
    <button id="devReset" class="tbtn">reset</button>
    <button id="devQuiz"  class="tbtn">quiz ▶︎</button>
  </div>

  <canvas id="confetti"></canvas>

  <!-- SFX -->
  <audio id="clickAudio" src="assets/sfx/click.mp3" preload="auto"></audio>
  <audio id="magicAudio" src="assets/sfx/magic.mp3" preload="auto"></audio>

  <!-- === MINI-GAME: Quick Quiz Modal === -->
  <div id="quizModal" style="display:none" aria-live="polite">
    <div class="quiz-backdrop"></div>
    <div class="quiz-card">
      <h2 id="quizTitle">クイズ！</h2>
      <p id="quizPrompt" class="quiz-prompt">音声を聞いて、正しいカードをタップ！</p>

      <div id="quizChoices" class="quiz-choices"></div>

      <div class="quiz-bottom">
        <div id="quizProgress" class="quiz-progress">1 / 3</div>
        <button id="quizClose" type="button" class="quiz-close" style="display:none">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ---- safety net: never let one error freeze the page ----
    (function trap(){
      const og = console.error.bind(console);
      window.addEventListener('error', e => { try{ og('JS error:', e.message); }catch{} }, {capture:true});
      window.addEventListener('unhandledrejection', e => { try{ og('Promise rejection:', e.reason); }catch{} });
    })();

    // ===== DEMO SWITCH =====
    // Set to false to re-enable daily unlock gating for the quiz & countdown
    const DEMO_MODE = true;

    const MS_DAY = 24*60*60*1000;
    const LS_KEY_START = "abc_start_ts";
    const LS_KEY_DONE  = "abc_done_letters";
    const LS_KEY_VIEWS = "abc_total_card_views"; // persisted overall view count
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    let startTs = localStorage.getItem(LS_KEY_START)?Number(localStorage.getItem(LS_KEY_START)):null;

    const hello = document.getElementById("hello");
    const startBtn = document.getElementById("startBtn");
    const barFill = document.getElementById("barFill");
    const countdown = document.getElementById("countdown");

    const cardImg = document.getElementById("cardImg");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const finishBtn = document.getElementById("finishBtn");
    const clickAudio = document.getElementById("clickAudio");
    const magicAudio = document.getElementById("magicAudio");

    // TEMP controls
    const devBack  = document.getElementById("devBack");
    const devNext  = document.getElementById("devNext");
    const devReset = document.getElementById("devReset");
    const devQuiz  = document.getElementById("devQuiz");

    // App state
    let activeIndex = 0;     // 0=A, 1=B, ...
    let audioStep = 0;       // 0..4 sequence with buttons 1..4
    let confettiRunning = false;
    let doneSet = loadDoneSet();

    // A–H now mapped (1..32.jpg)
    const MAX_LETTER_INDEX_FOR_CARDS = 7;

    // --- Mini game progress counters ---
    // Persisted total (optional analytics), and a per-session counter for fast triggering
    let totalViewsPersisted = Number(localStorage.getItem(LS_KEY_VIEWS) || 0);
    let sessionViews = 0; // resets on reload; triggers quiz every 4 views
    let seenThisLetter = new Set();

    function countViewOnce(n){
      if(!seenThisLetter.has(n)){
        seenThisLetter.add(n);

        // persisted counter (optional)
        totalViewsPersisted++;
        try{ localStorage.setItem(LS_KEY_VIEWS, String(totalViewsPersisted)); }catch{}

        // session counter for visible/fast triggers
        sessionViews++;
        if (sessionViews % 4 === 0) {
          setTimeout(()=> openQuickQuiz(), 120);
        }
      }
    }

    function startApp(){
      try {
        if(!startTs){ startTs = Date.now(); localStorage.setItem(LS_KEY_START, startTs); }
      } catch(_) {}
      hello.style.display = "none";
      showLetter(); // initial show
    }

    // Bind start robustly
    startBtn?.addEventListener('click', startApp);
    document.addEventListener('DOMContentLoaded', ()=> startBtn?.addEventListener('click', startApp));
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && hello.style.display !== 'none') startApp(); });

    function loadDoneSet(){
      try {
        const raw = localStorage.getItem(LS_KEY_DONE);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(arr);
      } catch { return new Set(); }
    }
    function saveDoneSet(){
      try { localStorage.setItem(LS_KEY_DONE, JSON.stringify([...doneSet])); } catch {}
    }

    // Daily unlock helpers (overridden in DEMO_MODE)
    function getUnlockedCount(){
      if (DEMO_MODE) return MAX_LETTER_INDEX_FOR_CARDS + 1; // A–H unlocked
      if(!startTs) return 0;
      const elapsed = Date.now() - startTs;
      const days = Math.floor(elapsed / MS_DAY);
      return Math.min(26, Math.max(1, days + 1));
    }
    function nextUnlockMs(){
      if (DEMO_MODE) return 0;
      if(!startTs) return null;
      const unlocked = getUnlockedCount();
      if(unlocked >= 26) return 0;
      return (startTs + unlocked*MS_DAY) - Date.now();
    }
    function fmt(ms){
      if(ms == null) return "—:—:—";
      const s = Math.floor(ms/1000);
      const h = String(Math.floor(s/3600)).padStart(2,"0");
      const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${h}:${m}:${ss}`;
    }

    // --- Card mapping (4 cards per letter) ---
    function getCardBase(letterIndex){
      // 0=A, 1=B, 2=C, ... → 0,4,8,12...
      return letterIndex * 4;
    }

    function setCard(n){
      // n is 1..4 within the current letter
      const base = getCardBase(Math.min(activeIndex, MAX_LETTER_INDEX_FOR_CARDS));
      const cardNum = base + n;  // e.g. B (index=1): base=4 → 5..8
      const src = `./${cardNum}.jpg`;
      cardImg.src = src;
      cardImg.alt = `カード${n}`;
      countViewOnce(n); // count first-time view of this card within the current letter
    }

    function setAllButtonsEnabled(on){
      [btn1,btn2,btn3,btn4].forEach(b => b.disabled = !on);
    }

    function setButtonStates(){
      btn1.disabled = !(audioStep === 0);
      btn2.disabled = !(audioStep === 1);
      btn3.disabled = !(audioStep === 2);
      btn4.disabled = !(audioStep === 3);
    }

    function playAudioFor(step){
      const L = letters[activeIndex];        // A/B/C/...
      const name = L.repeat(step);           // "A", "AA", "AAA", "AAAA"
      const src = `assets/audio/${name}.m4a`;
      const audio = new Audio(src);
      audio.play().catch(()=>{});
    }

    // Only Finish uses click SFX
    function playClick(){ try { clickAudio.currentTime = 0; clickAudio.play().catch(()=>{}); } catch(e) {} }

    function flashPressed(el){
      el.classList.add("pressed");
      setTimeout(()=>el.classList.remove("pressed"), 150);
    }

    // Show current letter
    function showLetter({preserveIndex=false} = {}){
      const unlocked = getUnlockedCount();
      if(!preserveIndex){
        // follow unlock (or DEMO full unlock), clamp to A–H for visuals
        activeIndex = Math.min(Math.max(unlocked - 1, 0), MAX_LETTER_INDEX_FOR_CARDS);
      }
      // progress bar & countdown
      barFill.style.width = (unlocked/26*100) + "%";
      countdown.textContent = DEMO_MODE ? "デモ" : (nextUnlockMs() === 0 ? "すべて解放" : fmt(nextUnlockMs()));

      // each letter starts fresh for "first-time card view" tracking
      seenThisLetter = new Set();

      // reset to first card of the current letter
      setCard(1);

      const L = letters[activeIndex];
      if (doneSet.has(L)){
        audioStep = 4;
        setAllButtonsEnabled(true);
        finishBtn.style.display = "none";
      } else {
        audioStep = 0;
        setButtonStates();
        finishBtn.style.display = "none";
      }
    }

    // Buttons 1–4: AUDIO ONLY (no SFX)
    btn1.onclick = () => { flashPressed(btn1);
      if(audioStep>0 && audioStep<4) return;
      setCard(1); playAudioFor(1);
      if(audioStep===0){ audioStep=1; setButtonStates(); }
    };
    btn2.onclick = () => { flashPressed(btn2);
      if(doneSet.has(letters[activeIndex])){ setCard(2); playAudioFor(2); return; }
      if(audioStep!==1) return;
      setCard(2); playAudioFor(2);
      audioStep=2; setButtonStates();
    };
    btn3.onclick = () => { flashPressed(btn3);
      if(doneSet.has(letters[activeIndex])){ setCard(3); playAudioFor(3); return; }
      if(audioStep!==2) return;
      setCard(3); playAudioFor(3);
      audioStep=3; setButtonStates();
    };
    btn4.onclick = () => { flashPressed(btn4);
      if(doneSet.has(letters[activeIndex])){ setCard(4); playAudioFor(4); return; }
      if(audioStep!==3) return;
      setCard(4); playAudioFor(4);
      audioStep=4; setButtonStates();
      finishBtn.style.display = "inline-block";
    };

    // Finish: plays SFX + confetti magic — and (for demo) launch quiz once per letter
    let quizzedThisLetter = false;
    finishBtn.onclick = () => {
      playClick(); flashPressed(finishBtn);
      const L = letters[activeIndex];
      if (!doneSet.has(L)){
        startConfetti(5000);
        doneSet.add(L);
        saveDoneSet();
      }
      setAllButtonsEnabled(true);
      finishBtn.style.display = "none";

      if (!quizzedThisLetter){
        quizzedThisLetter = true;
        setTimeout(()=> openQuickQuiz(), 250); // guaranteed visible
      }
    };

    // Update countdown if not in demo
    if(!DEMO_MODE){
      function tick(){
        const ms = nextUnlockMs();
        countdown.textContent = ms === 0 ? "すべて解放" : fmt(ms);
      }
      setInterval(tick, 1000);
      tick();
    }

    if(startTs){ hello.style.display="none"; showLetter(); }

    /* ---------- Confetti ---------- */
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    let confetti = [];
    function startConfetti(duration){
      if(confettiRunning) return;
      confettiRunning = true;
      try { magicAudio.currentTime = 0; magicAudio.play().catch(()=>{}); } catch(e) {}
      resize();
      confetti = Array.from({length:320}).map(()=>({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height - canvas.height,
        r: Math.random()*8 + 3,
        d: Math.random()*1 + 0.5,
        color: `hsl(${Math.random()*360},100%,50%)`
      }));
      const end = Date.now() + duration;
      (function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        confetti.forEach(p=>{
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,2*Math.PI);
          ctx.fillStyle = p.color; ctx.fill();
        });
        confetti.forEach(p=>{
          p.y += p.d*4;
          if(p.y>canvas.height){ p.y = -10; p.x = Math.random()*canvas.width; }
        });
        if(Date.now() < end){ requestAnimationFrame(draw); }
        else { confettiRunning = false; ctx.clearRect(0,0,canvas.width,canvas.height); }
      })();
    }
    window.onresize = resize;
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    resize();

    /* ===== MINI-GAME: Quick Quiz (3 rounds) ===== */
    const quizModal   = document.getElementById("quizModal");
    const quizChoices = document.getElementById("quizChoices");
    const quizTitle   = document.getElementById("quizTitle");
    const quizPrompt  = document.getElementById("quizPrompt");
    const quizProgress= document.getElementById("quizProgress");
    const quizClose   = document.getElementById("quizClose");

    let quizRound = 0;
    let quizTotal = 3;
    let quizBusy  = false;

    function openQuickQuiz(){
      if(!quizModal) return;
      quizRound = 0;
      quizBusy = false;
      quizClose.style.display = "none";
      quizModal.classList.add("active");
      nextQuizRound();
    }

    function closeQuickQuiz(){
      quizModal.classList.remove("active");
      // allow a new letter to trigger a quiz again
      quizzedThisLetter = false;
    }

    function playLetterAudio(L){
      const src = `assets/audio/${L}.m4a`;
      const a = new Audio(src);
      a.play().catch(()=>{});
    }

    // Build a pool of available letters
    function getAvailableLetterIndices(){
      if (DEMO_MODE){
        const arr = [];
        for(let i=0;i<=MAX_LETTER_INDEX_FOR_CARDS;i++) arr.push(i); // A–H
        return arr;
      }
      const maxIdx = Math.min(getUnlockedCount()-1, MAX_LETTER_INDEX_FOR_CARDS);
      const arr = [];
      for(let i=0;i<=maxIdx;i++) arr.push(i);
      return arr;
    }

    // Given a letterIndex, return a representative card image (card 1)
    function cardImageForLetterIndex(idx){
      const base = getCardBase(idx);
      const cardNum = base + 1; // use first card as the “alphabet card”
      return `./${cardNum}.jpg`;
    }

    function randomDistinct(arr, count, forbidIdx){
      const pool = arr.filter(i => i !== forbidIdx);
      pool.sort(()=>Math.random()-0.5);
      return pool.slice(0, count);
    }

    function nextQuizRound(){
      quizRound++;
      if (quizRound > quizTotal){
        // reward!
        startConfetti(1800);
        quizTitle.textContent = "すごい！";
        quizPrompt.textContent = "よくできました！";
        quizChoices.innerHTML = "";
        quizProgress.textContent = `${quizTotal} / ${quizTotal}`;
        quizClose.style.display = "inline-block";
        return;
      }

      const available = getAvailableLetterIndices();
      if(available.length < 3){
        // Not enough letters yet, just end quietly
        closeQuickQuiz();
        return;
      }

      const correctIdx = available[Math.floor(Math.random()*available.length)];
      const correctLetter = letters[correctIdx];

      // Build 2 distractors
      const distractors = randomDistinct(available, 2, correctIdx);

      // Shuffle choices
      const choiceIdxs = [correctIdx, ...distractors].sort(()=>Math.random()-0.5);

      quizTitle.textContent = "クイック・クイズ";
      quizPrompt.textContent = "音声を聞いて、正しいカードをえらぼう！";
      quizProgress.textContent = `${quizRound} / ${quizTotal}`;

      // Render buttons
      quizChoices.innerHTML = "";
      choiceIdxs.forEach(idx=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "quiz-choice";
        const img = document.createElement("img");
        img.src = cardImageForLetterIndex(idx);
        img.alt = `えらぶカード`;
        btn.appendChild(img);
        btn.onclick = () => {
          if(quizBusy) return;
          quizBusy = true;
          const isCorrect = idx === correctIdx;
          btn.classList.add(isCorrect ? "correct" : "wrong");
          if(isCorrect){
            try{ magicAudio.currentTime = 0; magicAudio.play().catch(()=>{});}catch{}
            setTimeout(()=>{ quizBusy=false; nextQuizRound(); }, 500);
          }else{
            setTimeout(()=>{ btn.classList.remove("wrong"); quizBusy=false; }, 450);
          }
        };
        quizChoices.appendChild(btn);
      });

      // Play the letter sound cue
      playLetterAudio(correctLetter);
    }

    // Close button
    quizClose?.addEventListener("click", closeQuickQuiz);
    // Also close if user taps the dark backdrop
    quizModal?.addEventListener("click", (e)=>{
      if(e.target.classList.contains("quiz-backdrop")) closeQuickQuiz();
    });

    /* ===== DEV BUTTON LOGIC (letters A→H) ===== */
    devBack.onclick = ()=>{
      if(activeIndex > 0){
        activeIndex--;
        audioStep = 0;
        finishBtn.style.display = "none";
        showLetter({preserveIndex:true});
      }
    };
    devNext.onclick = ()=>{
      if(activeIndex < MAX_LETTER_INDEX_FOR_CARDS){
        activeIndex++;
        audioStep = 0;
        finishBtn.style.display = "none";
        showLetter({preserveIndex:true});
      }
    };
    devReset.onclick = ()=>{
      try {
        localStorage.removeItem(LS_KEY_START);
        localStorage.removeItem(LS_KEY_DONE);
        localStorage.removeItem(LS_KEY_VIEWS);
      } finally {
        location.reload();
      }
    };
    devQuiz.onclick = ()=> openQuickQuiz();
  </script>
</body>
</html>
