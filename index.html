<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ブーハABC – スターター</title>

  <!-- App icon & PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="playful-pink-booha.png">
  <link rel="apple-touch-icon" sizes="180x180" href="playful-pink-booha.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ff4da6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ブーハABC">

  <!-- Minimal early fallback -->
  <script>
    function startApp(){
      const hello = document.getElementById('hello');
      if (hello) hello.style.display = 'none';
      const img = document.getElementById('letterImg');
      if (img) { img.src = './1.jpg'; img.alt = 'レター画像'; }
    }
    window.startApp = startApp;
  </script>

  <style>
    :root{ --topbar-h: 112px; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{overflow-x:hidden; background:#fff}
    .bg{position:fixed;inset:0;background:url("./booha-background.jpg") center/cover no-repeat;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.22);z-index:-1}

    /* CSS-only fallback: when #go is targeted, hide hello overlay (works with no JS) */
    #go:target ~ #hello{display:none}

    /* Hello / Start */
    .hello{position:fixed;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.78);z-index:10;padding:16px}
    .hello-card{position:relative;z-index:11;background:#fff;border-radius:20px;padding:24px;max-width:480px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .hello-card img{width:140px;height:auto;margin:0 auto;display:block}
    .hello-card h1{margin:12px 0 6px;font-size:24px;line-height:1.2}
    .hello-card p{margin:8px 0;font-size:14px;color:#444}
    .start-link{
      display:inline-block;margin-top:16px;padding:12px 20px;font-size:18px;font-weight:900;text-decoration:none;
      background:#ff4da6;color:#fff;border-radius:14px;box-shadow:0 10px 18px rgba(255,77,166,.28);cursor:pointer
    }
    .start-link:active{transform:scale(.98)}

    /* Top bar (mobile-safe) */
    .topbar{
      display:flex;align-items:center;gap:12px 14px;justify-content:space-between;
      padding:10px 16px; flex-wrap:wrap;
      background:rgba(255,255,255,.6); backdrop-filter:saturate(120%) blur(2px)
    }
    .left{display:flex;align-items:center;gap:12px;flex:1 1 auto;min-width:180px}
    .progress{width:220px; max-width:42vw}
    .bar{height:10px;background:#ffd1e6;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
    .bar>i{display:block;height:100%;background:#ff4da6;width:0%}
    .where{font-weight:800;min-width:3ch}

    /* Lock meter (wider + OUTSIDE ghost + purple fill) */
    .lockbox{display:flex;flex-direction:column;gap:6px;flex:1 1 280px;min-width:260px;max-width:680px}
    .lockline{font-size:12px;color:#444;display:flex;align-items:center;gap:6px;font-weight:700}
    .lockmeter{
      position:relative;height:16px;border-radius:999px;
      background:linear-gradient(90deg,#f1f5f9,#e2e8f0);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
      overflow:visible; /* important: allow outside ghost to show */
    }
    .lockmeter i{
      position:absolute;left:0;top:0;height:100%;width:0%;
      background:#7c3aed; /* purple fill */
      transition:width .6s
    }
    .lock-ghost{
      position:absolute;top:-22px; /* sit OUTSIDE above the bar */
      transform:translateX(-50%); left:0%;
      width:30px;height:30px;
      background:url('./playful-pink-booha.png') center/contain no-repeat;
      transition:left .6s;
      pointer-events:none; z-index:2;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.15));
    }
    .lock-unlocked{color:#16a34a;font-weight:700}

    /* Letter screen (use small viewport units for iOS) */
    .letter-screen{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      min-height:calc(100svh - var(--topbar-h));
      padding:16px;gap:16px;text-align:center;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
    }
    .card-wrap{display:grid;place-items:center;width:min(900px,96vw);min-height:36vh}
    .card-wrap img{max-width:100%;max-height:min(60svh, 560px);object-fit:contain;border-radius:12px}

    .buttons{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:12px;width:min(680px,92vw)}
    .btn-audio{display:flex;flex-direction:column;align-items:center;gap:6px;border:0;border-radius:18px;padding:16px 18px;font-size:18px;font-weight:900;color:#fff;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.20);transition:transform .12s, background .12s}
    .btn-audio .num{font-size:26px}
    .btn1{background:#ff5959}.btn2{background:#06b6d4}.btn3{background:#ffd166;color:#111}.btn4{background:#7c5cff}
    .btn-audio:active{transform:scale(.94)}
    .btn1.done{background:#ff7a7a}
    .btn2.done{background:#16c1de}
    .btn3.done{background:#ffe08c;color:#111}
    .btn4.done{background:#9a86ff}
    .btn-audio.done::after{content:" ✓";font-weight:900;font-size:14px;margin-left:4px}

    .btn-finish{margin-top:4px;padding:14px 18px;background:#28a745;color:#fff;font-size:20px;font-weight:900;border:0;border-radius:14px;cursor:pointer;display:none;box-shadow:0 10px 18px rgba(0,0,0,.18)}
    .btn-finish:active{transform:scale(.96)}

    /* Dev row */
    .dev{position:fixed;left:0;right:0;bottom:8px;display:flex;gap:8px;justify-content:center;z-index:60;
      padding-bottom:env(safe-area-inset-bottom)}
    .tbtn{background:#111;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-size:12px;opacity:.9;cursor:pointer}
    .tbtn:active{transform:scale(.98)}

    /* Confetti canvases */
    canvas#confettiFinish, canvas#confettiQuiz{position:fixed;inset:0;pointer-events:none}
    canvas#confettiFinish{z-index:50}
    canvas#confettiQuiz{z-index:200}

    /* TEST PAGE (modal) */
    #test{position:fixed;inset:0;z-index:180;display:none}
    #test.active{display:block}
    .t-back{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .t-card{position:relative;z-index:181;background:#fff;border-radius:20px;max-width:900px;margin:6vh auto;padding:16px 16px 18px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
    .t-title{margin:6px 0 2px;font-size:24px}
    .t-prompt{margin:4px 0 12px;color:#444}
    .t-ctrl{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .t-grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .t-item{background:#f7f7fb;border:2px solid transparent;border-radius:14px;padding:8px;display:grid;place-items:center;cursor:pointer;transition:transform .1s, border-color .12s}
    .t-item img{width:100%;height:170px;object-fit:contain}
    .t-item:active{transform:scale(.98)}
    .t-item.correct{border-color:#22c55e}
    .t-item.wrong{border-color:#ef4444}
    .t-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .t-btn{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer}
    .t-ok{background:#28a745}
    .t-progress{font-weight:800}
    .t-hint{display:none}
    @media (max-width:820px){.t-grid{grid-template-columns:repeat(2,1fr)}.t-item img{height:140px}}

    /* Tiny control panel */
    .ctrl{position:fixed;right:10px;bottom:10px;z-index:170}
    .ctrl > .fab{width:42px;height:42px;border-radius:999px;border:0;background:#111;color:#fff;font-weight:900;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.28)}
    .ctrl .panel{display:none;position:absolute;right:50px;bottom:0;background:#fff;border-radius:14px;padding:10px;box-shadow:0 14px 30px rgba(0,0,0,.25);min-width:190px}
    .ctrl.open .panel{display:block}
    .ctrl .row{display:flex;gap:6px;margin:6px 0}
    .ctrl .panel button,.ctrl .panel label{font-size:12px}
    .ctrl .panel button{border:0;background:#f1f5f9;border-radius:10px;padding:6px 8px;cursor:pointer}
    .ctrl .panel button:active{transform:scale(.98)}

    /* Extra small phones tweaks */
    @media (max-width:480px){
      .progress{width:44vw}
      .lockbox{flex-basis:100%}
      .lockmeter{height:14px}
      .lock-ghost{top:-20px;width:26px;height:26px}
      .card-wrap img{max-height:min(56svh, 500px)}
    }
  </style>
</head>
<body>
  <!-- CSS-only Start fallback anchor (no JS needed) -->
  <div id="go"></div>

  <div class="bg"></div>
  <div class="overlay"></div>

  <!-- Start / Hello -->
  <div id="hello" class="hello" aria-live="polite">
    <div class="hello-card">
      <img src="./playful-pink-booha.png" alt="Boohaロゴ" />
      <h1>スターターアプリへようこそ！</h1>
      <p>このアプリをホーム画面に追加してください。</p>
      <p>次の文字は <strong>24時間後</strong> にアンロックされます！</p>
      <a class="start-link" href="#go" onclick="startAppFull();">スタート</a>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="left">
      <div class="progress"><div class="bar"><i id="barFill"></i></div></div>
      <div id="where" class="where" aria-live="polite">A</div>
    </div>

    <div class="lockbox">
      <div class="lockline">
        <span id="lockStatus"><strong>次の文字は 24時間 後にアンロック</strong></span>
      </div>
      <div class="lockmeter" aria-label="24時間メーター">
        <i id="lockFill"></i>
        <span id="lockGhost" class="lock-ghost" style="left:0%"></span>
      </div>
    </div>
  </div>

  <!-- Letter screen -->
  <div class="letter-screen">
    <div class="card-wrap"><img id="letterImg" src="./1.jpg" alt="レター画像" /></div>
    <div class="buttons">
      <button id="btn1" class="btn-audio btn1"><span class="num">①</span><small>リピート</small></button>
      <button id="btn2" class="btn-audio btn2"><span class="num">②</span><small>いっしょに読む</small></button>
      <button id="btn3" class="btn-audio btn3"><span class="num">③</span><small>リピート</small></button>
      <button id="btn4" class="btn-audio btn4"><span class="num">④</span><small>スペシャル！</small></button>
    </div>
    <button id="finishBtn" class="btn-finish">できた！</button>
  </div>

  <!-- Dev nav -->
  <div class="dev">
    <button id="prev" class="tbtn">←</button>
    <button id="next" class="tbtn">→</button>
  </div>

  <!-- Confetti canvases -->
  <canvas id="confettiFinish"></canvas>
  <canvas id="confettiQuiz"></canvas>

  <!-- SFX fallback elements -->
  <audio id="clickAudio" src="assets/sfx/click.mp3" preload="auto"></audio>
  <audio id="magicAudio" src="assets/sfx/magic.mp3" preload="auto"></audio>

  <!-- TEST PAGE (modal) -->
  <div id="test">
    <div class="t-back"></div>
    <div class="t-card">
      <h2 class="t-title">テスト</h2>
      <p class="t-prompt">音声を聞いて、正しい<strong>文字</strong>をえらぼう！</p>
      <div class="t-ctrl">
        <button id="tPlay" class="t-btn">▶︎ 再生</button>
        <span id="tHint" class="t-hint"></span>
      </div>
      <div id="tGrid" class="t-grid"></div>
      <div class="t-bottom">
        <div id="tProgress" class="t-progress">1 / 1</div>
        <button id="tClose" class="t-btn t-ok" style="display:none">OK</button>
      </div>
    </div>
  </div>

  <!-- Tiny floating control panel -->
  <div id="ctrl" class="ctrl">
    <button class="fab" id="ctrlFab">⚙︎</button>
    <div class="panel">
      <div class="toggle"><input type="checkbox" id="bypassToggle" /> <label for="bypassToggle">24時間ロックを無視</label></div>
      <div class="row">
        <button id="ctrlPrev">◀︎</button>
        <button id="ctrlNext">▶︎</button>
      </div>
      <div class="row">
        <button id="ctrlUnlock">いま解放</button>
        <button id="ctrlTest">テスト</button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <script>
    /* ---------- Safety net ---------- */
    (function trap(){
      const og = console.error.bind(console);
      window.addEventListener('error', e => { try{ og('JS error:', e.message); }catch{} }, {capture:true});
      window.addEventListener('unhandledrejection', e => { try{ og('Promise rejection:', e.reason); }catch{} });
    })();

    /* ---------- Audio (with gain support) ---------- */
    let activeAudio = null;
    let audioCtx = null;
    function stopActive(){
      try{
        if(activeAudio){ activeAudio.pause(); activeAudio.currentTime = 0; }
      }catch(e){}
      activeAudio = null;
    }
    function playSound(src, gain=1){
      stopActive();
      try{
        const el = new Audio(src);
        activeAudio = el;
        if ('AudioContext' in window || 'webkitAudioContext' in window){
          audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
          const node = audioCtx.createMediaElementSource(el);
          const g = audioCtx.createGain();
          g.gain.value = gain;
          node.connect(g).connect(audioCtx.destination);
        } else {
          el.volume = Math.min(1, gain);
        }
        el.play().catch(()=>{});
      }catch(e){}
    }
    window.addEventListener('pagehide', stopActive);
    window.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopActive(); });

    /* ---------- Constants & DOM ---------- */
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const MAX_IDX = 14; // A..O
    const TOTAL_LETTERS = MAX_IDX + 1;

    // LocalStorage keys
    const LS_KEY_DONE = "abc_done_letters";
    const LS_KEY_LAST_TEST = "abc_last_test_m";
    const LS_KEY_UNLOCK_IDX = "abc_unlock_idx";
    const LS_KEY_NEXT_UNLOCK = "abc_next_unlock_ms";

    // DOM
    const barFill = document.getElementById("barFill");
    const where = document.getElementById("where");
    const letterImg = document.getElementById("letterImg");
    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const btn4 = document.getElementById("btn4");
    const finishBtn = document.getElementById("finishBtn");
    const clickAudio = document.getElementById("clickAudio");
    const lockStatus = document.getElementById("lockStatus");
    const lockFill = document.getElementById("lockFill");
    const lockGhost = document.getElementById("lockGhost");

    // Dev nav
    const prev = document.getElementById("prev");
    const next = document.getElementById("next");

    // Test modal
    const test = document.getElementById("test");
    const tGrid = document.getElementById("tGrid");
    const tPlay = document.getElementById("tPlay");
    const tHint = document.getElementById("tHint");
    const tClose = document.getElementById("tClose");
    const tProgress = document.getElementById("tProgress");

    // Control panel
    const ctrl = document.getElementById("ctrl");
    const ctrlFab = document.getElementById("ctrlFab");
    const ctrlPrev = document.getElementById("ctrlPrev");
    const ctrlNext = document.getElementById("ctrlNext");
    const ctrlUnlock = document.getElementById("ctrlUnlock");
    const ctrlTest = document.getElementById("ctrlTest");
    const bypassToggle = document.getElementById("bypassToggle");

    /* ---------- App state ---------- */
    let letterIdx
